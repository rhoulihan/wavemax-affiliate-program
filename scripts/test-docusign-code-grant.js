#!/usr/bin/env node
/**
 * Test DocuSign with Authorization Code Grant
 * Alternative to JWT authentication for testing
 */

require('dotenv').config();

const integrationKey = process.env.DOCUSIGN_INTEGRATION_KEY;
const secretKey = process.env.DOCUSIGN_SECRET_KEY;
const redirectUri = process.env.DOCUSIGN_REDIRECT_URI;
const oauthBaseUrl = process.env.DOCUSIGN_OAUTH_BASE_URL || 'https://account-d.docusign.com';

console.log('=== DocuSign Authorization Code Grant Test ===\n');

console.log('Configuration:');
console.log('- Integration Key:', integrationKey ? integrationKey.substring(0, 10) + '...' : 'NOT SET');
console.log('- Secret Key:', secretKey ? 'SET' : 'NOT SET');
console.log('- Redirect URI:', redirectUri);

if (!secretKey) {
  console.log('\n⚠️  DOCUSIGN_SECRET_KEY not found in environment');
  console.log('Authorization Code Grant requires a secret key.');
  console.log('\nFor JWT authentication to work, the DocuSign admin needs to:');
  console.log('1. Grant consent using the URL generated by get-docusign-consent-url.js');
  console.log('2. Ensure the private key matches the public key uploaded to DocuSign');
  console.log('\nAlternatively, you can:');
  console.log('1. Add DOCUSIGN_SECRET_KEY to your .env file');
  console.log('2. Use Authorization Code Grant flow instead of JWT');
} else {
  // Build authorization URL for testing
  const authUrl = `${oauthBaseUrl}/oauth/auth?` +
    'response_type=code&' +
    'scope=signature&' +
    `client_id=${integrationKey}&` +
    `redirect_uri=${encodeURIComponent(redirectUri)}`;

  console.log('\nAuthorization URL for testing:');
  console.log(authUrl);
  console.log('\nThis URL can be used to test DocuSign integration manually.');
}

console.log('\n=== Summary ===');
console.log('\nThe JWT authentication is failing because:');
console.log('1. The DocuSign user has not granted consent for impersonation');
console.log('2. The private key might not match the public key in DocuSign');
console.log('\nTo fix this:');
console.log('1. Have the DocuSign admin run: node scripts/get-docusign-consent-url.js');
console.log('2. Open the generated URL and grant consent');
console.log('3. Verify the RSA key pair matches in DocuSign app settings');
console.log('\nDocuSign JWT Guide: https://developers.docusign.com/platform/auth/jwt/');