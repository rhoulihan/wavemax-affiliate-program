
> wavemax-affiliate-program@1.0.0 test
> jest --runInBand test

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:47.915Z"}
[0mGET /api/csrf-token [32m200[0m 11.174 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:48.597Z"}
[0mPOST /api/v1/customers/register [32m201[0m 220.601 ms - 266[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:49.400Z"}
[0mGET /api/csrf-token [32m200[0m 1.508 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:49.765Z"}
[0mPOST /api/v1/customers/register [33m400[0m 30.560 ms - 50[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:50.272Z"}
[0mGET /api/csrf-token [32m200[0m 1.369 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:50.634Z"}
[0mPOST /api/v1/customers/register [33m400[0m 62.744 ms - 62[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:51.168Z"}
[0mGET /api/csrf-token [32m200[0m 0.844 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:51.514Z"}
[0mPOST /api/v1/customers/register [33m400[0m 53.773 ms - 62[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:52.051Z"}
[0mGET /api/csrf-token [32m200[0m 1.175 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:52.384Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 83.275 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:52.948Z"}
[0mGET /api/csrf-token [32m200[0m 6.009 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:53.291Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 79.257 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:53.843Z"}
[0mGET /api/csrf-token [32m200[0m 0.984 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:54.199Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 83.042 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:54.761Z"}
[0mGET /api/csrf-token [32m200[0m 1.458 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:55.100Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 83.107 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:55.660Z"}
[0mGET /api/csrf-token [32m200[0m 0.884 ms - 52[0m
[34mdebug[39m: PUT /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:55.993Z"}
[0mPUT /api/v1/customers/CUST123/profile [33m404[0m 1.776 ms - 128[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:56.481Z"}
[0mGET /api/csrf-token [32m200[0m 0.941 ms - 52[0m
[34mdebug[39m: PUT /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:56.822Z"}
[0mPUT /api/v1/customers/CUST123/profile [33m404[0m 1.275 ms - 128[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:57.302Z"}
[0mGET /api/csrf-token [32m200[0m 0.904 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/orders?page=1&limit=10 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:57.686Z"}
[0mGET /api/v1/customers/CUST123/orders?page=1&limit=10 [32m200[0m 83.614 ms - 582[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:58.269Z"}
[0mGET /api/csrf-token [32m200[0m 2.037 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/orders?status=delivered {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:58.718Z"}
[0mGET /api/v1/customers/CUST123/orders?status=delivered [32m200[0m 81.566 ms - 340[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:37:59.282Z"}
[0mGET /api/csrf-token [32m200[0m 0.711 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:00.131Z"}
[0mGET /api/csrf-token [32m200[0m 1.052 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:00.962Z"}
[0mGET /api/csrf-token [32m200[0m 3.244 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:01.782Z"}
[0mGET /api/csrf-token [32m200[0m 1.203 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/customers/CUST123/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:02.187Z"}
  console.log
    CSRF Debug - Path: /api/v1/customers/CUST123/delete-all-data

      at log (server.js:262:13)

  console.log
    CSRF Debug - Session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:38:02.188Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server.js:263:13)

  console.log
    CSRF Debug - Headers: {
      host: '127.0.0.1:37199',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcxZmNhYmM5MTEyNGI1OWU5YmNiNCIsImN1c3RvbWVySWQiOiJDVVNUMTIzIiwicm9sZSI6ImN1c3RvbWVyIiwiaWF0IjoxNzQ4NDQzMDgyfQ.b7oKtkzvD16U_lZwmaE68zfzAIV1cTr4ouV-Dn5oHCM',
      'x-csrf-token': 'vSHmROeB-CB9lz7EPjV8rFNjj8nG8tsaJYe8',
      connection: 'close'
    }

      at log (server.js:264:13)

  console.log
    CSRF Debug - Body: {}

      at log (server.js:265:13)

  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/customers/CUST123/delete-all-data

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: DELETE

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"DELETE","path":"/api/v1/customers/CUST123/delete-all-data","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:38:02.290Z","userId":null}
[0mDELETE /api/v1/customers/CUST123/delete-all-data [33m403[0m 104.051 ms - -[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:02.810Z"}
[0mGET /api/csrf-token [32m200[0m 2.914 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/customers/CUST123/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:03.124Z"}
  console.log
    CSRF Debug - Path: /api/v1/customers/CUST123/delete-all-data

      at log (server.js:262:13)

  console.log
    CSRF Debug - Session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:38:03.124Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server.js:263:13)

  console.log
    CSRF Debug - Headers: {
      host: '127.0.0.1:35209',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcxZmNiYmM5MTEyNGI1OWU5YmNkMiIsImN1c3RvbWVySWQiOiJDVVNUMTIzIiwicm9sZSI6ImN1c3RvbWVyIiwiaWF0IjoxNzQ4NDQzMDgzfQ.BGcjypMnXqM0TGFJcoMbYHu0ZSrf6oObXnOWtFxPSIU',
      'x-csrf-token': 'Ol7OIN9R-Gts6m-Aisg_8GKEf8uR2qeLWULs',
      connection: 'close'
    }

      at log (server.js:264:13)

  console.log
    CSRF Debug - Body: {}

      at log (server.js:265:13)

  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/customers/CUST123/delete-all-data

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: DELETE

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"DELETE","path":"/api/v1/customers/CUST123/delete-all-data","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:38:03.199Z","userId":null}
[0mDELETE /api/v1/customers/CUST123/delete-all-data [33m403[0m 76.326 ms - 48[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:03.740Z"}
[0mGET /api/csrf-token [32m200[0m 1.207 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/customers/CUST123/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:04.174Z"}
  console.log
    CSRF Debug - Path: /api/v1/customers/CUST123/delete-all-data

      at log (server.js:262:13)

  console.log
    CSRF Debug - Session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:38:04.175Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server.js:263:13)

  console.log
    CSRF Debug - Headers: {
      host: '127.0.0.1:32927',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcxZmNjYmM5MTEyNGI1OWU5YmNlZSIsImN1c3RvbWVySWQiOiJDVVNUNDU2Iiwicm9sZSI6ImN1c3RvbWVyIiwiaWF0IjoxNzQ4NDQzMDg0fQ._CFm91064xSboNS3fFeaXIasleqd7g2zEltErMWt1Gc',
      'x-csrf-token': 'MEjFyXF8-FpnBJ8UxFcM01ifSpO_y0TQRn58',
      connection: 'close'
    }

      at log (server.js:264:13)

  console.log
    CSRF Debug - Body: {}

      at log (server.js:265:13)

  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/customers/CUST123/delete-all-data

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: DELETE

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"DELETE","path":"/api/v1/customers/CUST123/delete-all-data","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:38:04.275Z","userId":null}
[0mDELETE /api/v1/customers/CUST123/delete-all-data [33m403[0m 100.646 ms - -[0m
FAIL tests/integration/customer.test.js (24.727 s)
  Customer Integration Tests
    POST /api/v1/customers/register
      ✓ should register a new customer (1549 ms)
      ✓ should fail with invalid affiliate ID (871 ms)
      ✓ should fail with duplicate email (897 ms)
      ✓ should fail with duplicate username (883 ms)
    GET /api/v1/customers/:customerId/profile
      ✕ should return customer profile for authenticated customer (896 ms)
      ✓ should return customer profile for affiliate (894 ms)
      ✕ should fail for unauthorized customer (918 ms)
      ✕ should fail without authentication (898 ms)
    PUT /api/v1/customers/:customerId/profile
      ✕ should update customer profile (820 ms)
      ✕ should not update protected fields (818 ms)
    GET /api/v1/customers/:customerId/orders
      ✕ should return customer orders with pagination (970 ms)
      ✓ should filter orders by status (1013 ms)
    POST /api/v1/customers/report-lost-bag
      ✕ should report lost bag (843 ms)
      ✕ should fail for non-existent bag (833 ms)
      ✕ should fail for unauthorized bag report (818 ms)
    PUT /api/v1/customers/:customerId/password
      ○ skipped should update customer password
      ○ skipped should fail with incorrect current password
      ○ skipped should fail with weak new password
    GET /api/v1/customers/:customerId/bags
      ○ skipped should return customer bags
      ○ skipped should filter bags by status
      ○ skipped should allow affiliate to view customer bags
    GET /api/v1/customers/:customerId/dashboard
      ○ skipped should return customer dashboard statistics
      ○ skipped should return monthly statistics
      ○ skipped should allow affiliate to view customer dashboard
    DELETE /api/v1/customers/:customerId/delete-all-data
      ✕ should delete all customer data in development environment (1030 ms)
      ✕ should reject deletion in production environment (928 ms)
      ✕ should reject unauthorized deletion (1045 ms)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/profile › should return customer profile for authenticated customer

    expect(received).toMatchObject(expected)

    - Expected  - 12
    + Received  +  0

      Object {
        "customer": Object {
    -     "address": "456 Oak Ave",
    -     "affiliate": Object {
    -       "affiliateId": "AFF123",
    -       "deliveryFee": 5.99,
    -       "name": "John Doe",
    -     },
    -     "city": "Austin",
          "customerId": "CUST123",
    -     "email": "jane@example.com",
          "firstName": "Jane",
          "lastName": "Smith",
    -     "phone": "555-987-6543",
    -     "serviceFrequency": "weekly",
    -     "state": "TX",
    -     "zipCode": "78702",
        },
        "success": true,
      }

      204 |
      205 |       expect(response.status).toBe(200);
    > 206 |       expect(response.body).toMatchObject({
          |                             ^
      207 |         success: true,
      208 |         customer: {
      209 |           customerId: 'CUST123',

      at Object.toMatchObject (tests/integration/customer.test.js:206:29)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/profile › should fail for unauthorized customer

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      251 |         .set('Authorization', `Bearer ${otherCustomerToken}`);
      252 |
    > 253 |       expect(response.status).toBe(403);
          |                               ^
      254 |       expect(response.body).toMatchObject({
      255 |         success: false,
      256 |         message: 'Unauthorized'

      at Object.toBe (tests/integration/customer.test.js:253:31)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/profile › should fail without authentication

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      262 |         .get('/api/v1/customers/CUST123/profile');
      263 |
    > 264 |       expect(response.status).toBe(401);
          |                               ^
      265 |     });
      266 |   });
      267 |

      at Object.toBe (tests/integration/customer.test.js:264:31)

  ● Customer Integration Tests › PUT /api/v1/customers/:customerId/profile › should update customer profile

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      278 |         });
      279 |
    > 280 |       expect(response.status).toBe(200);
          |                               ^
      281 |       expect(response.body).toMatchObject({
      282 |         success: true,
      283 |         message: 'Customer profile updated successfully!'

      at Object.toBe (tests/integration/customer.test.js:280:31)

  ● Customer Integration Tests › PUT /api/v1/customers/:customerId/profile › should not update protected fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      303 |         });
      304 |
    > 305 |       expect(response.status).toBe(200);
          |                               ^
      306 |
      307 |       // Verify protected fields were not updated
      308 |       const customer = await Customer.findOne({ customerId: 'CUST123' });

      at Object.toBe (tests/integration/customer.test.js:305:31)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/orders › should return customer orders with pagination

    expect(received).toMatchObject(expected)

    - Expected  - 2
    + Received  + 0

    @@ -6,12 +6,10 @@
          ObjectContaining {
            "orderId": "ORD002",
          },
        ],
        "pagination": Object {
    -     "currentPage": 1,
          "pages": 1,
    -     "perPage": 10,
          "total": 2,
        },
        "success": true,
      }

      357 |
      358 |       expect(response.status).toBe(200);
    > 359 |       expect(response.body).toMatchObject({
          |                             ^
      360 |         success: true,
      361 |         orders: expect.arrayContaining([
      362 |           expect.objectContaining({ orderId: 'ORD001' }),

      at Object.toMatchObject (tests/integration/customer.test.js:359:29)

  ● Customer Integration Tests › POST /api/v1/customers/report-lost-bag › should report lost bag

    ValidationError: Bag validation failed: barcode: Path `barcode` is required., status: `active` is not a valid enum value for path `status`.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Customer Integration Tests › POST /api/v1/customers/report-lost-bag › should fail for non-existent bag

    ValidationError: Bag validation failed: barcode: Path `barcode` is required., status: `active` is not a valid enum value for path `status`.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Customer Integration Tests › POST /api/v1/customers/report-lost-bag › should fail for unauthorized bag report

    ValidationError: Bag validation failed: barcode: Path `barcode` is required., status: `active` is not a valid enum value for path `status`.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Customer Integration Tests › DELETE /api/v1/customers/:customerId/delete-all-data › should delete all customer data in development environment

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      744 |         .set('X-CSRF-Token', csrfToken);
      745 |
    > 746 |       expect(response.status).toBe(200);
          |                               ^
      747 |       expect(response.body).toMatchObject({
      748 |         success: true,
      749 |         message: 'All data has been deleted successfully'

      at Object.toBe (tests/integration/customer.test.js:746:31)

  ● Customer Integration Tests › DELETE /api/v1/customers/:customerId/delete-all-data › should reject deletion in production environment

    expect(received).toMatchObject(expected)

    - Expected  - 1
    + Received  + 1

      Object {
    -   "message": "This operation is not allowed in production",
    +   "message": "invalid csrf token",
        "success": false,
      }

      774 |
      775 |       expect(response.status).toBe(403);
    > 776 |       expect(response.body).toMatchObject({
          |                             ^
      777 |         success: false,
      778 |         message: 'This operation is not allowed in production'
      779 |       });

      at Object.toMatchObject (tests/integration/customer.test.js:776:29)

  ● Customer Integration Tests › DELETE /api/v1/customers/:customerId/delete-all-data › should reject unauthorized deletion

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      821 |       // Since the controller uses req.user.customerId, not the URL param,
      822 |       // this will succeed and delete CUST456's data
    > 823 |       expect(response.status).toBe(200);
          |                               ^
      824 |       expect(response.body).toMatchObject({
      825 |         success: true,
      826 |         message: 'All data has been deleted successfully'

      at Object.toBe (tests/integration/customer.test.js:823:31)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:06.237Z"}
[0mGET /api/csrf-token [32m200[0m 2.328 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:06.919Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:38:07.097Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 178.715 ms - 509[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:07.606Z"}
[0mGET /api/csrf-token [32m200[0m 0.936 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:07.858Z"}
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:07.938Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 79.381 ms - 58[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:08.429Z"}
[0mGET /api/csrf-token [32m200[0m 1.000 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:08.592Z"}
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"User not found","success":false,"timestamp":"2025-05-28T14:38:08.619Z","userType":"affiliate","username":"nonexistent"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 28.039 ms - 58[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:09.089Z"}
[0mGET /api/csrf-token [32m200[0m 1.419 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/customer/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:09.379Z"}
  console.log
    Customer affiliateId: AFF123

      at log (server/controllers/authController.js:465:13)

  console.log
    Found affiliate: AFF123

      at log (server/controllers/authController.js:466:13)

  console.log
    Affiliate delivery fee: 5.99

      at log (server/controllers/authController.js:467:13)

  console.log
    Sending customer login response: {
      "customerId": "CUST123",
      "firstName": "Jane",
      "lastName": "Smith",
      "email": "jane@example.com",
      "phone": "555-987-6543",
      "address": "456 Oak Ave",
      "city": "Austin",
      "state": "TX",
      "zipCode": "78702",
      "affiliateId": "AFF123",
      "affiliate": {
        "affiliateId": "AFF123",
        "name": "John Doe",
        "deliveryFee": 5.99
      }
    }

      at log (server/controllers/authController.js:499:13)

[0mPOST /api/v1/auth/customer/login [32m200[0m 150.355 ms - 632[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:10.013Z"}
[0mGET /api/csrf-token [32m200[0m 3.599 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:10.270Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:38:10.421Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 151.854 ms - 509[0m
[34mdebug[39m: GET /api/v1/auth/verify {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:10.424Z"}
[0mGET /api/v1/auth/verify [32m200[0m 1.715 ms - 99[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:10.902Z"}
[0mGET /api/csrf-token [32m200[0m 0.927 ms - 52[0m
[34mdebug[39m: GET /api/v1/auth/verify {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:11.064Z"}
[0mGET /api/v1/auth/verify [33m401[0m 1.030 ms - 43[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:11.528Z"}
[0mGET /api/csrf-token [32m200[0m 1.065 ms - 52[0m
[34mdebug[39m: GET /api/v1/auth/verify {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:11.693Z"}
[0mGET /api/v1/auth/verify [33m401[0m 0.935 ms - 47[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:12.166Z"}
[0mGET /api/csrf-token [32m200[0m 0.744 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:12.416Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:38:12.594Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 179.118 ms - 509[0m
[34mdebug[39m: POST /api/v1/auth/refresh-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:12.597Z"}
[0mPOST /api/v1/auth/refresh-token [32m200[0m 140.504 ms - 409[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:13.244Z"}
[0mGET /api/csrf-token [32m200[0m 1.063 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/refresh-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:13.427Z"}
[0mPOST /api/v1/auth/refresh-token [33m400[0m 1.187 ms - 89[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:13.900Z"}
[0mGET /api/csrf-token [32m200[0m 0.898 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/refresh-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:14.225Z"}
[0mPOST /api/v1/auth/refresh-token [33m401[0m 32.635 ms - 62[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:14.745Z"}
[0mGET /api/csrf-token [32m200[0m 0.677 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.018Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.021Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.024Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.026Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.028Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.029Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.031Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.037Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.040Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.043Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.045Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.047Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.049Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.051Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.052Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.057Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.063Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.065Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.067Z"}
[0mPOST /api/v1/auth/affiliate/login [33m429[0m 2.750 ms - 77[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.072Z"}
[0mPOST /api/v1/auth/affiliate/login [33m429[0m 0.617 ms - 77[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:15.073Z"}
[0mPOST /api/v1/auth/affiliate/login [33m429[0m 0.576 ms - 77[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.133Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 114.427 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.193Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 172.129 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.247Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 224.118 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.309Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 283.420 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.370Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 342.115 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.425Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 396.161 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.481Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 449.532 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.535Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 492.376 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.594Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 549.408 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.648Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 600.687 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.709Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 660.193 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.760Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 709.561 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.820Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 768.605 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.874Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 817.199 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.944Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 881.266 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:15.997Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 931.898 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:16.168Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 1132.143 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:38:16.220Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 1179.931 ms - 58[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:16.756Z"}
[0mGET /api/csrf-token [32m200[0m 0.778 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/administrator/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:17.041Z"}
[0mPOST /api/v1/auth/administrator/login [33m429[0m 3.538 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:17.539Z"}
[0mGET /api/csrf-token [32m200[0m 0.716 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/administrator/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:17.801Z"}
[0mPOST /api/v1/auth/administrator/login [33m429[0m 0.910 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:18.285Z"}
[0mGET /api/csrf-token [32m200[0m 2.362 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/administrator/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:18.544Z"}
[0mPOST /api/v1/auth/administrator/login [33m429[0m 0.925 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:19.025Z"}
[0mGET /api/csrf-token [32m200[0m 0.856 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:19.686Z"}
[0mGET /api/csrf-token [32m200[0m 1.169 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:20.353Z"}
[0mGET /api/csrf-token [32m200[0m 1.836 ms - 52[0m
FAIL tests/integration/auth.test.js (16.226 s)
  Authentication Integration Tests
    POST /api/v1/auth/affiliate/login
      ✓ should login affiliate with valid credentials (1402 ms)
      ✓ should fail with invalid credentials (822 ms)
      ✓ should fail with non-existent username (660 ms)
    POST /api/v1/auth/customer/login
      ✓ should login customer with valid credentials (924 ms)
    GET /api/v1/auth/verify
      ✓ should verify valid token (889 ms)
      ✓ should fail with invalid token (622 ms)
      ✓ should fail with missing token (641 ms)
    POST /api/v1/auth/refresh-token
      ✓ should refresh token successfully (1078 ms)
      ✓ should fail with invalid refresh token (654 ms)
      ✓ should fail with expired refresh token (847 ms)
    POST /api/v1/auth/logout
      ○ skipped should logout successfully and blacklist tokens
    Rate limiting tests
      ✕ should rate limit login attempts (2010 ms)
      ○ skipped should rate limit refresh token requests
    Concurrent refresh token usage
      ○ skipped should handle concurrent refresh token requests safely
    Token blacklisting after logout
      ○ skipped should blacklist all active tokens on logout
    POST /api/v1/auth/administrator/login
      ✕ should login administrator with valid credentials (783 ms)
      ✕ should fail with invalid administrator credentials (745 ms)
      ✕ should fail when administrator is inactive (740 ms)
    POST /api/v1/auth/operator/login
      ✕ should login operator with valid credentials (658 ms)
      ✕ should fail with invalid operator credentials (667 ms)
      ✕ should fail when operator is inactive (656 ms)

  ● Authentication Integration Tests › Rate limiting tests › should rate limit login attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 429

      475 |       // First 20 attempts should fail with invalid credentials
      476 |       for (let i = 0; i < 20; i++) {
    > 477 |         expect(responses[i].status).toBe(401);
          |                                     ^
      478 |       }
      479 |
      480 |       // 21st attempt should be rate limited

      at Object.toBe (tests/integration/auth.test.js:477:37)

  ● Authentication Integration Tests › POST /api/v1/auth/administrator/login › should login administrator with valid credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 429

      683 |         });
      684 |
    > 685 |       expect(response.status).toBe(200);
          |                               ^
      686 |       expect(response.body).toMatchObject({
      687 |         success: true,
      688 |         token: expect.any(String),

      at Object.toBe (tests/integration/auth.test.js:685:31)

  ● Authentication Integration Tests › POST /api/v1/auth/administrator/login › should fail with invalid administrator credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 429

      717 |         });
      718 |
    > 719 |       expect(response.status).toBe(401);
          |                               ^
      720 |       expect(response.body).toMatchObject({
      721 |         success: false,
      722 |         message: 'Invalid credentials'

      at Object.toBe (tests/integration/auth.test.js:719:31)

  ● Authentication Integration Tests › POST /api/v1/auth/administrator/login › should fail when administrator is inactive

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 429

      744 |         });
      745 |
    > 746 |       expect(response.status).toBe(403);
          |                               ^
      747 |       expect(response.body).toMatchObject({
      748 |         success: false,
      749 |         message: 'Account is inactive'

      at Object.toBe (tests/integration/auth.test.js:746:31)

  ● Authentication Integration Tests › POST /api/v1/auth/operator/login › should login operator with valid credentials

    ValidationError: Operator validation failed: createdBy: Path `createdBy` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Authentication Integration Tests › POST /api/v1/auth/operator/login › should fail with invalid operator credentials

    ValidationError: Operator validation failed: createdBy: Path `createdBy` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Authentication Integration Tests › POST /api/v1/auth/operator/login › should fail when operator is inactive

    ValidationError: Operator validation failed: createdBy: Path `createdBy` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:22.490Z"}
[0mGET /api/csrf-token [32m200[0m 2.503 ms - 52[0m
[34mdebug[39m: POST /api/v1/affiliates/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:22.690Z"}
[0mPOST /api/v1/affiliates/register [32m201[0m 441.492 ms - 89[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:23.647Z"}
[0mGET /api/csrf-token [32m200[0m 1.270 ms - 52[0m
[34mdebug[39m: GET /api/v1/affiliates/AFF206124 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:23.729Z"}
[0mGET /api/v1/affiliates/AFF206124 [32m200[0m 30.738 ms - 355[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:24.274Z"}
[0mGET /api/csrf-token [32m200[0m 1.440 ms - 52[0m
[34mdebug[39m: PUT /api/v1/affiliates/AFF817772 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:24.340Z"}
  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/affiliates/AFF817772

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: PUT

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"PUT","path":"/api/v1/affiliates/AFF817772","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:38:24.411Z","userId":null}
[0mPUT /api/v1/affiliates/AFF817772 [33m403[0m 72.247 ms - -[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:24.925Z"}
[0mGET /api/csrf-token [32m200[0m 1.081 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:25.088Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:38:25.240Z","userType":"affiliate","username":"testaffiliate"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 152.996 ms - 522[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:25.715Z"}
[0mGET /api/csrf-token [32m200[0m 0.743 ms - 52[0m
[34mdebug[39m: GET /api/v1/affiliates/AFF384020/customers?page=1&limit=10 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:25.816Z"}
[0mGET /api/v1/affiliates/AFF384020/customers?page=1&limit=10 [32m200[0m 83.707 ms - 602[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:26.381Z"}
[0mGET /api/csrf-token [32m200[0m 0.781 ms - 52[0m
[34mdebug[39m: GET /api/v1/affiliates/AFF977457/orders?page=1&limit=10 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:26.493Z"}
[0mGET /api/v1/affiliates/AFF977457/orders?page=1&limit=10 [32m200[0m 82.029 ms - 741[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:27.057Z"}
[0mGET /api/csrf-token [32m200[0m 1.093 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:27.607Z"}
[0mGET /api/csrf-token [32m200[0m 0.849 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/affiliates/AFF154140/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:27.766Z"}
  console.log
    Delete data request received

      at log (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at log (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: { affiliateId: 'AFF154140' }

      at log (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: {
      id: '68371fe378616126e86dc558',
      role: 'affiliate',
      affiliateId: 'AFF154140'
    }

      at log (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: {
      host: '127.0.0.1:41617',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcxZmUzNzg2MTYxMjZlODZkYzU1OCIsImFmZmlsaWF0ZUlkIjoiQUZGMTU0MTQwIiwicm9sZSI6ImFmZmlsaWF0ZSIsImlhdCI6MTc0ODQ0MzEwNywiZXhwIjoxNzQ4NDQ2NzA3fQ.PkNK-HRsE_2-KHneIZf9fCjvAlJfwsH_fUyT5E2cphs',
      'x-csrf-token': '7sGDdxbg-Cy39V1OoxEbyGWYKawzx9kZEXWk',
      connection: 'close'
    }

      at log (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:38:27.768Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at log (server/controllers/affiliateController.js:830:13)

[0mDELETE /api/v1/affiliates/AFF154140/delete-all-data [32m200[0m 223.029 ms - 225[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:28.569Z"}
[0mGET /api/csrf-token [32m200[0m 0.908 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/affiliates/AFF962000/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:38:28.630Z"}
  console.log
    Delete data request received

      at log (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: production

      at log (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: { affiliateId: 'AFF962000' }

      at log (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: {
      id: '68371fe478616126e86dc57d',
      role: 'affiliate',
      affiliateId: 'AFF962000'
    }

      at log (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: {
      host: '127.0.0.1:45077',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcxZmU0Nzg2MTYxMjZlODZkYzU3ZCIsImFmZmlsaWF0ZUlkIjoiQUZGOTYyMDAwIiwicm9sZSI6ImFmZmlsaWF0ZSIsImlhdCI6MTc0ODQ0MzEwOCwiZXhwIjoxNzQ4NDQ2NzA4fQ.TwIoK2eeK1yClBdb5GLyWVrjlZotXuQGEWKyyR7yaBA',
      'x-csrf-token': 'UHi7AQtD-pc6f-nA7Fby5lFh18IVgU1alcZQ',
      connection: 'close'
    }

      at log (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:38:28.631Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at log (server/controllers/affiliateController.js:830:13)

  console.log
    Environment check failed

      at log (server/controllers/affiliateController.js:834:15)

[0mDELETE /api/v1/affiliates/AFF962000/delete-all-data [33m403[0m 28.416 ms - 73[0m
FAIL tests/integration/affiliate.test.js (8.102 s)
  Affiliate API
    ✓ should register a new affiliate (1192 ms)
    ✓ should get affiliate profile (626 ms)
    ✕ should update affiliate profile (651 ms)
    ✓ should login affiliate (790 ms)
    ✕ should get affiliate's customers list (665 ms)
    ✕ should get affiliate's orders (675 ms)
    ✕ should get affiliate's earnings/transactions (548 ms)
    ✓ Delete all affiliate data (development only) (960 ms)
    ✓ Reject delete in production environment (564 ms)
    ○ skipped should update payment information
    ○ skipped should handle commission-related endpoints

  ● Affiliate API › should update affiliate profile

    expect(received).toEqual(expected) // deep equality

    Expected: 200
    Received: 403

       98 |       });
       99 |
    > 100 |     expect(res.statusCode).toEqual(200);
          |                            ^
      101 |     expect(res.body).toHaveProperty('success', true);
      102 |
      103 |     // Verify the update

      at Object.toEqual (tests/integration/affiliate.test.js:100:28)

  ● Affiliate API › should get affiliate's customers list

    expect(received).toMatchObject(expected)

    - Expected  - 2
    + Received  + 0

      Object {
    -   "currentPage": 1,
        "pages": 1,
    -   "perPage": 10,
        "total": 2,
      }

      177 |     expect(res.body.customers).toHaveLength(2);
      178 |     expect(res.body).toHaveProperty('pagination');
    > 179 |     expect(res.body.pagination).toMatchObject({
          |                                 ^
      180 |       total: 2,
      181 |       pages: 1,
      182 |       currentPage: 1,

      at Object.toMatchObject (tests/integration/affiliate.test.js:179:33)

  ● Affiliate API › should get affiliate's orders

    expect(received).toHaveProperty(path, value)

    Expected path: "totalEarnings"
    Received path: []

    Expected value: 44.41
    Received value: {"orders": [{"createdAt": "2025-05-28T14:38:26.454Z", "customer": null, "customerId": "CUST002", "deliveryDate": "2025-05-28T00:00:00.000Z", "deliveryTime": "morning", "estimatedSize": "large", "estimatedTotal": 72.14, "orderId": "ORD002", "pickupDate": "2025-05-26T00:00:00.000Z", "pickupTime": "afternoon", "status": "processing"}, {"actualTotal": 50.41, "actualWeight": 23.5, "createdAt": "2025-05-28T14:38:26.454Z", "customer": null, "customerId": "CUST001", "deliveryDate": "2025-05-27T00:00:00.000Z", "deliveryTime": "afternoon", "estimatedSize": "medium", "estimatedTotal": 49.46, "orderId": "ORD001", "pickupDate": "2025-05-25T00:00:00.000Z", "pickupTime": "morning", "status": "delivered"}], "pagination": {"limit": "10", "page": "1", "pages": 1, "total": 2}, "success": true, "totalItems": 2}

      229 |     expect(res.body.orders).toHaveLength(2);
      230 |     expect(res.body).toHaveProperty('pagination');
    > 231 |     expect(res.body).toHaveProperty('totalEarnings', 44.41);
          |                      ^
      232 |   });
      233 |
      234 |   test('should get affiliate\'s earnings/transactions', async () => {

      at Object.toHaveProperty (tests/integration/affiliate.test.js:231:22)

  ● Affiliate API › should get affiliate's earnings/transactions

    ValidationError: Transaction validation failed: payoutMethod: Path `payoutMethod` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

FAIL tests/unit/models.test.js (7.098 s)
  Model Tests
    Affiliate Model
      ✓ should create a valid affiliate (582 ms)
      ✓ should require required fields (318 ms)
      ✕ should enforce unique constraints (373 ms)
      ○ skipped should handle payment information correctly
    Customer Model
      ✕ should create a valid customer (348 ms)
      ✕ should validate service frequency (348 ms)
    Order Model
      ✓ should create a valid order (356 ms)
      ✓ should calculate estimated total correctly (350 ms)
      ✓ should calculate actual total and commission when weight is set (354 ms)
      ✓ should update timestamps for status changes (467 ms)
    Bag Model
      ✓ should create a valid bag (353 ms)
      ✓ should generate unique barcodes (388 ms)
    Transaction Model
      ✓ should create a valid transaction (346 ms)
      ✓ should validate transaction type (308 ms)
      ✓ should validate transaction status (324 ms)
    RefreshToken Model
      ✓ should create a valid refresh token (344 ms)
      ✓ should validate user type (310 ms)
      ✓ should check if token is expired (381 ms)

  ● Model Tests › Affiliate Model › should enforce unique constraints

    expect(received).toBeDefined()

    Received: undefined

      90 |       }
      91 |
    > 92 |       expect(error).toBeDefined();
         |                     ^
      93 |       expect(error.code).toBe(11000); // MongoDB duplicate key error
      94 |     });
      95 |

      at Object.toBeDefined (tests/unit/models.test.js:92:21)

  ● Model Tests › Customer Model › should create a valid customer

    expect(received).toBe(expected) // Object.is equality

    Expected: "weekly"
    Received: undefined

      145 |       expect(saved.email).toBe('jane@example.com');
      146 |       expect(saved.isActive).toBe(true); // Default value
    > 147 |       expect(saved.serviceFrequency).toBe('weekly');
          |                                      ^
      148 |     });
      149 |
      150 |     it('should validate service frequency', async () => {

      at Object.toBe (tests/unit/models.test.js:147:38)

  ● Model Tests › Customer Model › should validate service frequency

    expect(received).toBeDefined()

    Received: undefined

      172 |
      173 |       expect(error).toBeDefined();
    > 174 |       expect(error.errors.serviceFrequency).toBeDefined();
          |                                             ^
      175 |     });
      176 |   });
      177 |

      at Object.toBeDefined (tests/unit/models.test.js:174:45)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

FAIL tests/unit/administratorController.test.js (278.482 s)
  Administrator Controller
    Operator Management
      createOperator
        ✕ should create a new operator (387 ms)
      getOperators
        ✕ should return list of operators with pagination (51 ms)
      updateOperator
        ✕ should update operator details (51 ms)
    Analytics
      getDashboard
        ✕ should return dashboard analytics (61 ms)
      getOrderAnalytics
        ✕ should return order analytics (51 ms)
    System Configuration
      getSystemConfig
        ✕ should return all system configurations (54 ms)
      updateSystemConfig
        ✕ should update system configuration (53 ms)
        ✕ should return 404 if configuration not found (52 ms)
    System Health
      getSystemHealth
        ✕ should return system health status (51 ms)

  ● Administrator Controller › Operator Management › createOperator › should create a new operator

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › Operator Management › getOperators › should return list of operators with pagination

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › Operator Management › updateOperator › should update operator details

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › Analytics › getDashboard › should return dashboard analytics

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › Analytics › getOrderAnalytics › should return order analytics

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › System Configuration › getSystemConfig › should return all system configurations

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › System Configuration › updateSystemConfig › should update system configuration

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › System Configuration › updateSystemConfig › should return 404 if configuration not found

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  ● Administrator Controller › System Health › getSystemHealth › should return system health status

    thrown: "Exceeded timeout of 60000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      38 |
      39 | // Set up MongoDB connection before tests
    > 40 | beforeAll(async () => {
         | ^
      41 |   try {
      42 |     await mongoose.connect(testUri);
      43 |     console.log('Connected to test database:', testUri.replace(/\/\/[^:]+:[^@]+@/, '//***:***@'));

      at Object.beforeAll (tests/setup.js:40:1)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

FAIL tests/unit/operatorController.test.js
  Operator Controller
    getDashboard
      ✓ should return operator dashboard data (5 ms)
    getOrderQueue
      ✕ should return available orders for operator workstation (5 ms)
    claimOrder
      ✕ should allow operator to claim an order (3 ms)
      ✕ should fail if order is already claimed (1 ms)
    updateOrderStatus
      ✓ should update order status (10 ms)
    performQualityCheck
      ✕ should record quality check results (2 ms)
    getMyOrders
      ✕ should return orders assigned to operator (1 ms)
    updateShiftStatus
      ✕ should update operator shift status (1 ms)
    getPerformanceStats
      ✕ should return operator performance statistics
    getCustomerDetails
      ✕ should return customer details for an order
    addCustomerNote
      ✕ should add a note to an order (1 ms)

  ● Operator Controller › getOrderQueue › should return available orders for operator workstation

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
        "orderProcessingStatus": "pending",
    -   "scheduledPickup": Object {
    -     "$lte": Any<Date>,
    -   },
      },

    Number of calls: 1

      128 |       await getOrderQueue(req, res);
      129 |
    > 130 |       expect(Order.find).toHaveBeenCalledWith({
          |                          ^
      131 |         orderProcessingStatus: 'pending',
      132 |         scheduledPickup: { $lte: expect.any(Date) }
      133 |       });

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:130:26)

  ● Operator Controller › claimOrder › should allow operator to claim an order

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Order claimed successfully",
    -   "order": Object {
    -     "_id": "order123",
    -     "assignedOperator": "op123",
    -     "orderNumber": "ORD001",
    -     "orderProcessingStatus": "assigned",
    -     "processingStarted": 2025-05-28T14:43:16.959Z,
    -     "save": [Function mockConstructor],
    -   },
    +   "error": "Failed to claim order",
      },

    Number of calls: 1

      159 |       expect(mockOrder.processingStarted).toBeDefined();
      160 |       expect(mockOrder.save).toHaveBeenCalled();
    > 161 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      162 |         message: 'Order claimed successfully',
      163 |         order: mockOrder
      164 |       });

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:161:24)

  ● Operator Controller › claimOrder › should fail if order is already claimed

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "error": "Order is already assigned to another operator",
    +   "error": "Order already assigned",
      },

    Number of calls: 1

      180 |
      181 |       expect(res.status).toHaveBeenCalledWith(400);
    > 182 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      183 |         error: 'Order is already assigned to another operator'
      184 |       });
      185 |     });

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:182:24)

  ● Operator Controller › performQualityCheck › should record quality check results

    expect(received).toMatchObject(expected)

    - Expected  - 6
    + Received  + 1

    - Object {
    -   "notes": "All items clean and properly folded",
    -   "passed": true,
    -   "performedAt": Any<Date>,
    -   "performedBy": "op123",
    - }
    + Object {}

      242 |       await performQualityCheck(req, res);
      243 |
    > 244 |       expect(mockOrder.qualityCheck).toMatchObject({
          |                                      ^
      245 |         passed: true,
      246 |         performedBy: 'op123',
      247 |         performedAt: expect.any(Date),

      at Object.toMatchObject (tests/unit/operatorController.test.js:244:38)

  ● Operator Controller › getMyOrders › should return orders assigned to operator

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "count": 2,
    -   "orders": Array [
    -     Object {
    -       "_id": "1",
    -       "orderNumber": "ORD001",
    -       "orderProcessingStatus": "processing",
    -     },
    -     Object {
    -       "_id": "2",
    -       "orderNumber": "ORD002",
    -       "orderProcessingStatus": "ready",
    -     },
    -   ],
    -   "success": true,
    +   "error": "Failed to fetch orders",
      },

    Number of calls: 1

      272 |
      273 |       expect(Order.find).toHaveBeenCalledWith({ assignedOperator: 'op123' });
    > 274 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      275 |         success: true,
      276 |         orders: mockOrders,
      277 |         count: 2

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:274:24)

  ● Operator Controller › updateShiftStatus › should update operator shift status

    expect(received).toBe(expected) // Object.is equality

    Expected: "active"
    Received: "inactive"

      295 |       await updateShiftStatus(req, res);
      296 |
    > 297 |       expect(mockOperator.shiftStatus).toBe('active');
          |                                        ^
      298 |       expect(mockOperator.lastStatusUpdate).toBeDefined();
      299 |       expect(mockOperator.save).toHaveBeenCalled();
      300 |       expect(auditLogger.log).toHaveBeenCalledWith('operator', 'op123', 'shift.status_updated', expect.any(Object));

      at Object.toBe (tests/unit/operatorController.test.js:297:40)

  ● Operator Controller › getPerformanceStats › should return operator performance statistics

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      323 |       await getPerformanceStats(req, res);
      324 |
    > 325 |       expect(Order.aggregate).toHaveBeenCalled();
          |                               ^
      326 |       expect(res.json).toHaveBeenCalledWith({
      327 |         stats: {
      328 |           totalOrders: 50,

      at Object.toHaveBeenCalled (tests/unit/operatorController.test.js:325:31)

  ● Operator Controller › getCustomerDetails › should return customer details for an order

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "order123"

    Number of calls: 0

      359 |       await getCustomerDetails(req, res);
      360 |
    > 361 |       expect(Order.findById).toHaveBeenCalledWith('order123');
          |                              ^
      362 |       expect(res.json).toHaveBeenCalledWith({
      363 |         customer: mockOrder.customer,
      364 |         orderDetails: {

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:361:30)

  ● Operator Controller › addCustomerNote › should add a note to an order

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      391 |       await addCustomerNote(req, res);
      392 |
    > 393 |       expect(mockOrder.customerNotes).toHaveLength(1);
          |                                       ^
      394 |       expect(mockOrder.customerNotes[0]).toMatchObject({
      395 |         note: 'Customer requested extra starch',
      396 |         addedBy: 'op123',

      at Object.toHaveLength (tests/unit/operatorController.test.js:393:39)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

  console.warn
    Welcome email could not be sent: Error: Email failed
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:161:64)
        at Promise.then.completed (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:252:3)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at run (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:444:34)

      93 |       // Email sent successfully - no need to check result
      94 |     } catch (emailError) {
    > 95 |       console.warn('Welcome email could not be sent:', emailError);
         |               ^
      96 |       // Continue with registration process even if email fails
      97 |     }
      98 |

      at Object.warn [as registerAffiliate] (server/controllers/affiliateController.js:95:15)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:163:7)

  console.error
    Affiliate registration error: Error: Database error
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:178:43)
        at Promise.then.completed (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:252:3)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at run (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:444:34)

      103 |     });
      104 |   } catch (error) {
    > 105 |     console.error('Affiliate registration error:', error);
          |             ^
      106 |     res.status(500).json({
      107 |       success: false,
      108 |       message: 'An error occurred during registration'

      at Object.error [as registerAffiliate] (server/controllers/affiliateController.js:105:13)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:180:7)

  console.error
    Error decrypting PayPal email: Error: Decryption failed
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:275:15)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/jest-mock/build/index.js:397:39
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-mock/build/index.js:404:13)
        at Object.mockConstructor [as decrypt] (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-mock/build/index.js:148:19)
        at Object.decrypt [as getAffiliateProfile] (/var/www/wavemax/wavemax-affiliate-program/server/controllers/affiliateController.js:163:28)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:278:7)

      164 |           : affiliate.paypalEmail;
      165 |       } catch (error) {
    > 166 |         console.error('Error decrypting PayPal email:', error);
          |                 ^
      167 |         // Don't include if decryption fails
      168 |       }
      169 |     }

      at Object.error [as getAffiliateProfile] (server/controllers/affiliateController.js:166:17)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:278:7)

  console.error
    Get affiliate orders error: TypeError: Cannot read properties of undefined (reading 'forEach')
        at Object.forEach [as getAffiliateOrders] (/var/www/wavemax/wavemax-affiliate-program/server/controllers/affiliateController.js:580:15)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:684:7)

      619 |     });
      620 |   } catch (error) {
    > 621 |     console.error('Get affiliate orders error:', error);
          |             ^
      622 |     res.status(500).json({
      623 |       success: false,
      624 |       message: 'An error occurred while retrieving orders'

      at Object.error [as getAffiliateOrders] (server/controllers/affiliateController.js:621:13)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:684:7)

  console.error
    Get affiliate profile error: Error: Database connection lost
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:876:43)
        at Promise.then.completed (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:252:3)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at run (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:444:34)

      175 |     });
      176 |   } catch (error) {
    > 177 |     console.error('Get affiliate profile error:', error);
          |             ^
      178 |     res.status(500).json({
      179 |       success: false,
      180 |       message: 'An error occurred while retrieving affiliate profile'

      at Object.error [as getAffiliateProfile] (server/controllers/affiliateController.js:177:13)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:878:7)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF123' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: production

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF123' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

  console.log
    Environment check failed

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:834:15)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF456' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF123' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

FAIL tests/unit/affiliateController.test.js
  Affiliate Controller
    registerAffiliate
      ✓ should successfully register a new affiliate (2 ms)
      ✓ should return validation errors
      ✓ should handle duplicate email or username (1 ms)
      ✓ should handle email service failure gracefully (100 ms)
      ✓ should handle database errors (3 ms)
    getAffiliateProfile
      ✓ should return affiliate profile for authorized user (1 ms)
      ✓ should return 404 for non-existent affiliate (4 ms)
      ✓ should return 403 for unauthorized access
      ✓ should handle decryption errors gracefully (21 ms)
    updateAffiliateProfile
      ✓ should successfully update affiliate profile (4 ms)
      ✓ should handle password change (1 ms)
      ✓ should reject incorrect current password (4 ms)
      ✓ should update payment method (1 ms)
    getAffiliateEarnings
      ✓ should return earnings for specified period (1 ms)
      ✓ should handle different time periods
      ✓ should handle missing customers gracefully (1 ms)
    getAffiliateCustomers
      ✓ should return paginated customers with search (1 ms)
      ✓ should handle different sort options
    getAffiliateOrders
      ✓ should return filtered orders (1 ms)
      ✓ should handle date filters correctly (2 ms)
    getAffiliateTransactions
      ✓ should return paginated transactions
    getAffiliateDashboardStats
      ✓ should return comprehensive dashboard statistics (2 ms)
      ✓ should handle empty data gracefully
    getPublicAffiliateInfo
      ✓ should return only public affiliate information (3 ms)
      ✓ should return 404 for non-existent affiliate
    Error handling
      ✓ should handle database connection errors (2 ms)
    deleteAffiliateData
      ✕ should delete all affiliate data in development environment (9 ms)
      ✓ should reject deletion in production environment (11 ms)
      ✕ should reject unauthorized deletion (4 ms)
      ✕ should handle deletion errors (9 ms)

  ● Affiliate Controller › deleteAffiliateData › should delete all affiliate data in development environment

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"$or": [{"affiliateId": "AFF123"}, {"customerId": {"$in": ["CUST1", "CUST2"]}}]}

    Number of calls: 0

      909 |       await affiliateController.deleteAffiliateData(req, res);
      910 |
    > 911 |       expect(Order.deleteMany).toHaveBeenCalledWith({
          |                                ^
      912 |         $or: [
      913 |           { affiliateId: 'AFF123' },
      914 |           { customerId: { $in: ['CUST1', 'CUST2'] } }

      at Object.toHaveBeenCalledWith (tests/unit/affiliateController.test.js:911:32)

  ● Affiliate Controller › deleteAffiliateData › should reject unauthorized deletion

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Unauthorized",
    +   "message": "You can only delete your own data",
        "success": false,
      },

    Number of calls: 1

      960 |
      961 |       expect(res.status).toHaveBeenCalledWith(403);
    > 962 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      963 |         success: false,
      964 |         message: 'Unauthorized'
      965 |       });

      at Object.toHaveBeenCalledWith (tests/unit/affiliateController.test.js:962:24)

  ● Affiliate Controller › deleteAffiliateData › should handle deletion errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 403

    Number of calls: 1

      973 |       await affiliateController.deleteAffiliateData(req, res);
      974 |
    > 975 |       expect(res.status).toHaveBeenCalledWith(500);
          |                          ^
      976 |       expect(res.json).toHaveBeenCalledWith({
      977 |         success: false,
      978 |         message: 'An error occurred while deleting data'

      at Object.toHaveBeenCalledWith (tests/unit/affiliateController.test.js:975:26)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:20.561Z"}
[0mGET /api/csrf-token [32m200[0m 3.731 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:21.243Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST123',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      specialPickupInstructions: 'Ring doorbell',
      estimatedSize: 'medium',
      serviceNotes: 'Handle with care',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon',
      specialDeliveryInstructions: 'Leave at door'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST123

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Jane Smith

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: AFF123

      at log (server/controllers/orderController.js:62:13)

  console.log
    Found affiliate: John Doe

      at log (server/controllers/orderController.js:72:13)

[0mPOST /api/v1/orders [32m201[0m 117.491 ms - 104[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:21.931Z"}
[0mGET /api/csrf-token [32m200[0m 1.097 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:22.240Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST123',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'small',
      deliveryDate: '2025-05-27',
      deliveryTime: 'evening'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST123

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Jane Smith

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: AFF123

      at log (server/controllers/orderController.js:62:13)

  console.log
    Found affiliate: John Doe

      at log (server/controllers/orderController.js:72:13)

[0mPOST /api/v1/orders [32m201[0m 90.012 ms - 104[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:22.815Z"}
[0mGET /api/csrf-token [32m200[0m 1.111 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:23.093Z"}
  console.log
    Creating order with data: {
      customerId: 'INVALID',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'medium',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: INVALID

      at log (server/controllers/orderController.js:49:13)

  console.log
    Customer not found with ID: INVALID

      at log (server/controllers/orderController.js:53:15)

[0mPOST /api/v1/orders [33m400[0m 30.594 ms - 49[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:23.601Z"}
[0mGET /api/csrf-token [32m200[0m 0.878 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:23.877Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST123',
      affiliateId: 'INVALID',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'medium',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST123

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Jane Smith

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: INVALID

      at log (server/controllers/orderController.js:62:13)

  console.log
    Affiliate not found with ID: INVALID

      at log (server/controllers/orderController.js:66:15)

[0mPOST /api/v1/orders [33m400[0m 64.372 ms - 50[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:24.433Z"}
[0mGET /api/csrf-token [32m200[0m 1.002 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:24.745Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST999',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'medium',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST999

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Bob Jones

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: AFF123

      at log (server/controllers/orderController.js:62:13)

  console.log
    Found affiliate: John Doe

      at log (server/controllers/orderController.js:72:13)

[0mPOST /api/v1/orders [33m403[0m 101.361 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:25.504Z"}
[0mGET /api/csrf-token [32m200[0m 1.121 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:25.779Z"}
  console.log
    Validation errors: [
      {
        type: 'field',
        value: undefined,
        msg: 'Valid pickup date is required',
        path: 'pickupDate',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Invalid pickup time',
        path: 'pickupTime',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Invalid size',
        path: 'estimatedSize',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Valid delivery date is required',
        path: 'deliveryDate',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Invalid delivery time',
        path: 'deliveryTime',
        location: 'body'
      }
    ]

      at log (server/controllers/orderController.js:25:15)

[0mPOST /api/v1/orders [33m400[0m 3.570 ms - 497[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:26.266Z"}
[0mGET /api/csrf-token [32m200[0m 1.075 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/ORD123456 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:26.585Z"}
[0mGET /api/v1/orders/ORD123456 [32m200[0m 88.976 ms - 656[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:27.155Z"}
[0mGET /api/csrf-token [32m200[0m 0.865 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/ORD123456 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:27.463Z"}
[0mGET /api/v1/orders/ORD123456 [32m200[0m 81.146 ms - 656[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:28.028Z"}
[0mGET /api/csrf-token [32m200[0m 0.973 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/ORD123456 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:28.347Z"}
[0mGET /api/v1/orders/ORD123456 [33m403[0m 28.240 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:28.857Z"}
[0mGET /api/csrf-token [32m200[0m 0.830 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/NONEXISTENT {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:29.177Z"}
[0mGET /api/v1/orders/NONEXISTENT [33m404[0m 31.910 ms - 45[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:29.696Z"}
[0mGET /api/csrf-token [32m200[0m 0.802 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:30.016Z"}
[0mPUT /api/v1/orders/ORD123456/status [32m200[0m 120.164 ms - 106[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:30.660Z"}
[0mGET /api/csrf-token [32m200[0m 0.973 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:31.022Z"}
[0mPUT /api/v1/orders/ORD123456/status [32m200[0m 112.065 ms - 175[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:31.647Z"}
[0mGET /api/csrf-token [32m200[0m 0.779 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:32.009Z"}
[0mPUT /api/v1/orders/ORD123456/status [33m400[0m 29.229 ms - 83[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:32.525Z"}
[0mGET /api/csrf-token [32m200[0m 0.737 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:32.848Z"}
[0mPUT /api/v1/orders/ORD123456/status [33m403[0m 30.583 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:33.381Z"}
[0mGET /api/csrf-token [32m200[0m 0.806 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:33.708Z"}
[0mPUT /api/v1/orders/ORD123456/status [33m403[0m 28.522 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:34.219Z"}
[0mGET /api/csrf-token [32m200[0m 0.882 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:34.544Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [32m200[0m 113.136 ms - 57[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:35.173Z"}
[0mGET /api/csrf-token [32m200[0m 0.873 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:35.503Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [32m200[0m 113.102 ms - 57[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:36.096Z"}
[0mGET /api/csrf-token [32m200[0m 0.852 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:36.443Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [33m400[0m 29.523 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:36.951Z"}
[0mGET /api/csrf-token [32m200[0m 2.328 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:43:37.417Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [33m403[0m 33.249 ms - 42[0m
PASS tests/integration/order.test.js (18.696 s)
  Order Integration Tests
    POST /api/v1/orders
      ✓ should create order as customer (1418 ms)
      ✓ should create order as affiliate for their customer (883 ms)
      ✓ should fail with invalid customer ID (786 ms)
      ✓ should fail with invalid affiliate ID (831 ms)
      ✓ should fail when customer tries to create order for another customer (1071 ms)
      ✓ should validate required fields (759 ms)
    GET /api/v1/orders/:orderId
      ✓ should return order details for customer (892 ms)
      ✓ should return order details for affiliate (873 ms)
      ✓ should fail for unauthorized customer (828 ms)
      ✓ should return 404 for non-existent order (839 ms)
    PUT /api/v1/orders/:orderId/status
      ✓ should update order status as affiliate (963 ms)
      ✓ should update weight when processing (987 ms)
      ✓ should prevent invalid status transitions (874 ms)
      ✓ should fail for unauthorized affiliate (857 ms)
      ✓ should fail for customers (838 ms)
    POST /api/v1/orders/:orderId/cancel
      ✓ should cancel order as customer (955 ms)
      ✓ should cancel order as affiliate (923 ms)
      ✓ should prevent cancelling non-cancellable orders (855 ms)
      ✓ should fail for unauthorized user (991 ms)
    Bulk order operations
      ○ skipped should update multiple orders status in bulk
      ○ skipped should handle partial bulk update failures
      ○ skipped should cancel multiple orders in bulk
    Order export functionality
      ○ skipped should export orders as CSV
      ○ skipped should export orders as JSON
      ○ skipped should export orders as Excel
      ○ skipped should respect export permissions
    Payment status updates
      ○ skipped should update payment status
      ○ skipped should handle payment failure
      ○ skipped should prevent payment status update on non-delivered orders
      ○ skipped should record refund
    Order filtering and search
      ○ skipped should search orders by customer name
      ○ skipped should filter orders by multiple criteria
      ○ skipped should filter by pickup time slots
      ○ skipped should provide aggregated statistics with filters

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

Killed
