<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2 Payment System - Post-Weigh Payment Flow | WaveMAX Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .breadcrumb {
            background: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .content-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #2c3e50;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        h3 {
            color: #34495e;
            margin: 20px 0 15px 0;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #667eea;
        }
        
        code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
        }
        
        .alert-warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            color: #e65100;
        }
        
        .alert-success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }
        
        .flow-diagram {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .flow-step {
            display: inline-block;
            background: white;
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 5px;
            margin: 10px;
        }
        
        .flow-arrow {
            display: inline-block;
            margin: 0 10px;
            color: #667eea;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .feature-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>V2 Payment System Documentation</h1>
            <p>Post-Weigh Payment Flow Implementation</p>
        </div>
    </header>

    <div class="container">
        <div class="breadcrumb">
            <a href="index.html">Documentation</a> / <span>V2 Payment System</span>
        </div>

        <div class="content-section">
            <h2>Overview</h2>
            <p>The V2 Payment System implements a post-weigh payment flow where customers pay after their laundry has been weighed and processed, ensuring accurate pricing based on actual weight rather than estimates.</p>
            
            <div class="alert alert-info">
                <strong>Key Difference:</strong> Unlike V1 where payment is collected upfront, V2 requests payment after the actual weight is determined, providing transparent and accurate pricing.
            </div>

            <h3>Core Features</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>üìä Accurate Pricing</h4>
                    <p>Customers pay based on actual weight, not estimates</p>
                </div>
                <div class="feature-card">
                    <h4>üí≥ Multiple Payment Methods</h4>
                    <p>Support for Venmo, PayPal, and CashApp</p>
                </div>
                <div class="feature-card">
                    <h4>üìß Email Payment Verification</h4>
                    <p>Automatic payment detection via email scanning</p>
                </div>
                <div class="feature-card">
                    <h4>üîÑ Automated Reminders</h4>
                    <p>Progressive reminder system for pending payments</p>
                </div>
                <div class="feature-card">
                    <h4>‚ö†Ô∏è Admin Notifications</h4>
                    <p>Alerts for underpayments, overpayments, and duplicates</p>
                </div>
                <div class="feature-card">
                    <h4>üéØ QR Code Support</h4>
                    <p>Easy payment via QR codes for mobile users</p>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h2>Payment Flow Diagram</h2>
            <div class="flow-diagram">
                <div class="flow-step">Customer Schedules Pickup</div>
                <span class="flow-arrow">‚Üí</span>
                <div class="flow-step">Bags Collected & Weighed</div>
                <span class="flow-arrow">‚Üí</span>
                <div class="flow-step">Payment Request Sent</div>
                <span class="flow-arrow">‚Üí</span>
                <div class="flow-step">Customer Pays</div>
                <span class="flow-arrow">‚Üí</span>
                <div class="flow-step">Payment Verified</div>
                <span class="flow-arrow">‚Üí</span>
                <div class="flow-step">Laundry Processed</div>
                <span class="flow-arrow">‚Üí</span>
                <div class="flow-step">Ready for Delivery</div>
            </div>
        </div>

        <div class="content-section">
            <h2>Implementation Details</h2>

            <h3>1. Order Creation</h3>
            <p>When a V2 customer schedules a pickup, the order is created with specific V2 fields:</p>
            <pre><code>{
  registrationVersion: 'v2',
  v2PaymentStatus: 'pending',
  v2PaymentMethod: 'pending',
  v2PaymentAmount: 0,  // Set after weighing
  estimatedWeight: 10, // Initial estimate
  actualWeight: null   // Set after weighing
}</code></pre>

            <h3>2. Weighing and Payment Request</h3>
            <p>When the operator weighs the bags:</p>
            <ol>
                <li>Actual weight is recorded in the order</li>
                <li>Total cost is calculated based on actual weight</li>
                <li>Payment links and QR codes are generated</li>
                <li>Payment request email is sent to customer</li>
            </ol>

            <pre><code>// Payment request trigger in operatorController.js
if (order.bagsWeighed === order.numberOfBags) {
  const paymentAmount = calculateActualTotal(order);
  const paymentURLs = await generatePaymentURLs(order);
  
  order.v2PaymentStatus = 'awaiting';
  order.v2PaymentRequestedAt = new Date();
  
  await emailService.sendV2PaymentRequest({
    customer,
    order,
    paymentAmount,
    paymentLinks: paymentURLs.links,
    qrCodes: paymentURLs.qrCodes
  });
}</code></pre>

            <h3>3. Payment Methods</h3>
            <table>
                <thead>
                    <tr>
                        <th>Method</th>
                        <th>Format</th>
                        <th>Detection</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Venmo</td>
                        <td>venmo://paycharge?txn=pay&recipients=username&amount=X&note=Order</td>
                        <td>Email forwarding from venmo@venmo.com</td>
                        <td>Most popular method</td>
                    </tr>
                    <tr>
                        <td>PayPal</td>
                        <td>paypal.me/username/amount</td>
                        <td>Email from service@paypal.com</td>
                        <td>Wide acceptance</td>
                    </tr>
                    <tr>
                        <td>CashApp</td>
                        <td>cash.app/$cashtag/amount</td>
                        <td>Email from cash@square.com</td>
                        <td>Growing usage</td>
                    </tr>
                </tbody>
            </table>

            <h3>4. Payment Verification</h3>
            <p>The system uses two methods to verify payments:</p>

            <h4>A. Email Scanner (Primary)</h4>
            <ul>
                <li>Runs every 60 seconds</li>
                <li>Connects to payments@wavemax.promo inbox via IMAP</li>
                <li>Looks for forwarded payment confirmations</li>
                <li>Parses order ID from payment note</li>
                <li>Verifies amount matches or exceeds order total</li>
            </ul>

            <h4>B. Manual Confirmation (Backup)</h4>
            <ul>
                <li>Customer can click "I've Already Paid" button</li>
                <li>Sets status to 'confirming'</li>
                <li>Scanner prioritizes these orders</li>
                <li>Provides immediate feedback to customer</li>
            </ul>

            <div class="alert alert-warning">
                <strong>Important:</strong> Payment emails must be forwarded to payments@wavemax.promo with the order ID in the payment note (e.g., "WaveMAX Order ORD-xxx-xxx-xxx")
            </div>
        </div>

        <div class="content-section">
            <h2>Admin Notifications</h2>
            
            <h3>Payment Issue Alerts</h3>
            <p>Administrators are automatically notified of payment issues:</p>
            
            <table>
                <thead>
                    <tr>
                        <th>Issue Type</th>
                        <th>Trigger</th>
                        <th>Action Required</th>
                        <th>Email Priority</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Underpayment</strong></td>
                        <td>Payment amount < order total</td>
                        <td>Contact customer for remaining amount</td>
                        <td>High</td>
                    </tr>
                    <tr>
                        <td><strong>Overpayment</strong></td>
                        <td>Payment amount > order total</td>
                        <td>Consider refund or apply as credit</td>
                        <td>Normal</td>
                    </tr>
                    <tr>
                        <td><strong>Duplicate Payment</strong></td>
                        <td>Payment for already verified order</td>
                        <td>Refund duplicate payment immediately</td>
                        <td>Normal</td>
                    </tr>
                </tbody>
            </table>

            <pre><code>// Admin notification configuration
const adminEmail = await SystemConfig.getValue(
  'admin_notification_email', 
  'admin@wavemaxlaundry.com'
);

await emailService.sendAdminNotification({
  subject: `${issueType} - Order ${order.orderId}`,
  html: notificationContent,
  priority: issueType === 'underpayment' ? 'high' : 'normal'
});</code></pre>
        </div>

        <div class="content-section">
            <h2>Reminder System</h2>
            
            <h3>Automated Payment Reminders</h3>
            <p>The system sends progressive reminders for unpaid orders:</p>
            
            <ol>
                <li><strong>30 minutes:</strong> First gentle reminder</li>
                <li><strong>1 hour:</strong> Second reminder with urgency indicator</li>
                <li><strong>2 hours:</strong> Third reminder, more urgent tone</li>
                <li><strong>3 hours:</strong> Final reminder before escalation</li>
                <li><strong>4 hours:</strong> Escalation to admin, order marked as failed</li>
            </ol>

            <div class="alert alert-info">
                <strong>Note:</strong> Each reminder includes fresh payment links and QR codes in case the original was lost.
            </div>

            <pre><code>// Reminder logic in paymentVerificationJob.js
shouldSendReminder(order) {
  const attempts = order.v2PaymentCheckAttempts || 0;
  
  // Send reminders at specific intervals
  if (attempts === 6) return true;  // 30 minutes
  if (attempts === 12) return true; // 1 hour
  if (attempts === 24) return true; // 2 hours
  if (attempts === 36) return true; // 3 hours
  
  return false;
}</code></pre>
        </div>

        <div class="content-section">
            <h2>Operator Workflow Integration</h2>
            
            <h3>Operator Scan System</h3>
            <p>The V2 payment system is fully integrated with the operator scanning workflow:</p>
            
            <h4>Scanning Flow with V2 Payments</h4>
            <ol>
                <li><strong>Initial Scan (Bag Receipt):</strong>
                    <ul>
                        <li>Operator scans customer QR code with bag number</li>
                        <li>Bag is auto-registered in the system</li>
                        <li>When all bags scanned, weight entry is enabled</li>
                    </ul>
                </li>
                <li><strong>Weight Entry:</strong>
                    <ul>
                        <li>Operator enters actual weight for each bag</li>
                        <li>System calculates total cost</li>
                        <li>Payment request is automatically sent</li>
                    </ul>
                </li>
                <li><strong>Post-WDF Scan:</strong>
                    <ul>
                        <li>Operator scans bags after wash/dry/fold</li>
                        <li>System checks payment status</li>
                        <li>If paid: sends pickup notification to affiliate</li>
                        <li>If unpaid: blocks completion, shows payment pending</li>
                    </ul>
                </li>
                <li><strong>Pickup Scan:</strong>
                    <ul>
                        <li>Affiliate scans bags for pickup</li>
                        <li>System verifies payment before allowing pickup</li>
                        <li>Sends delivery notification to customer with affiliate info</li>
                    </ul>
                </li>
            </ol>

            <div class="alert alert-success">
                <strong>Payment Gate:</strong> Orders cannot proceed to pickup without payment verification, ensuring no unpaid deliveries.
            </div>
        </div>

        <div class="content-section">
            <h2>Testing Tools</h2>
            
            <h3>Test Payment System</h3>
            <p>Available at <code>/test-operator-scan.html</code></p>
            
            <h4>Features:</h4>
            <ul>
                <li>Send test Venmo payment emails</li>
                <li>Adjust payment amounts to test over/underpayment</li>
                <li>Monitor payment detection in real-time</li>
                <li>Test duplicate payment scenarios</li>
            </ul>

            <pre><code>// Test payment email generation
await fetch('/api/v1/test/send-payment-email', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': csrfToken
  },
  body: JSON.stringify({
    orderId: testOrder.orderId,
    amount: 25.00,
    senderName: 'Test User'
  })
});</code></pre>

            <h3>Useful Scripts</h3>
            <pre><code># Update payment scanner interval
node scripts/update-payment-interval.js

# Send test Venmo email
node scripts/send-test-venmo-email.js

# Test payment notifications
node scripts/test-payment-notifications.js

# Check order payment status
node scripts/check-order.js</code></pre>
        </div>

        <div class="content-section">
            <h2>Configuration</h2>
            
            <h3>System Configuration</h3>
            <table>
                <thead>
                    <tr>
                        <th>Setting</th>
                        <th>Key</th>
                        <th>Default</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Payment Check Interval</td>
                        <td>payment_check_interval_minutes</td>
                        <td>1</td>
                        <td>How often to check for new payments</td>
                    </tr>
                    <tr>
                        <td>Admin Email</td>
                        <td>admin_notification_email</td>
                        <td>admin@wavemaxlaundry.com</td>
                        <td>Where to send payment issue alerts</td>
                    </tr>
                    <tr>
                        <td>Payment Timeout</td>
                        <td>payment_timeout_hours</td>
                        <td>4</td>
                        <td>Hours before marking payment as failed</td>
                    </tr>
                    <tr>
                        <td>Venmo Username</td>
                        <td>venmo_username</td>
                        <td>wavemaxATX</td>
                        <td>Venmo account for payments</td>
                    </tr>
                    <tr>
                        <td>PayPal Username</td>
                        <td>paypal_username</td>
                        <td>wavemaxlaundry</td>
                        <td>PayPal.me username</td>
                    </tr>
                    <tr>
                        <td>CashApp Username</td>
                        <td>cashapp_username</td>
                        <td>wavemaxatx</td>
                        <td>CashApp $cashtag</td>
                    </tr>
                </tbody>
            </table>

            <h3>Environment Variables</h3>
            <pre><code># Email configuration for payment inbox
PAYMENT_EMAIL_HOST=mail.wavemax.promo
PAYMENT_EMAIL_PORT=993
PAYMENT_EMAIL_USER=payments@wavemax.promo
PAYMENT_EMAIL_PASSWORD=your-password
PAYMENT_EMAIL_TLS=true</code></pre>
        </div>

        <div class="content-section">
            <h2>Troubleshooting</h2>
            
            <h3>Common Issues</h3>
            
            <h4>Payment Not Detected</h4>
            <ul>
                <li>Verify email is forwarded to payments@wavemax.promo</li>
                <li>Check order ID format in payment note (ORD-xxx-xxx)</li>
                <li>Ensure payment amount matches or exceeds order total</li>
                <li>Check scanner logs: <code>pm2 logs wavemax | grep payment</code></li>
            </ul>

            <h4>Scanner Connection Issues</h4>
            <ul>
                <li>Verify IMAP credentials in environment variables</li>
                <li>Check firewall allows port 993 (IMAP SSL)</li>
                <li>Test connection: <code>node scripts/test-imap-connection.js</code></li>
            </ul>

            <h4>Admin Notifications Not Sending</h4>
            <ul>
                <li>Verify admin email in SystemConfig</li>
                <li>Check SMTP configuration</li>
                <li>Review email logs: <code>tail -f /root/.pm2/logs/wavemax-out.log | grep "Admin notification"</code></li>
            </ul>

            <div class="alert alert-info">
                <strong>Debug Mode:</strong> Enable detailed logging with <code>DEBUG=payment:* npm start</code>
            </div>
        </div>

        <div class="content-section">
            <h2>API Endpoints</h2>
            
            <h3>V2 Payment Endpoints</h3>
            <pre><code>// Confirm payment manually
POST /api/v1/orders/:orderId/confirm-payment
{
  "confirmed": true
}

// Check payment status
GET /api/v1/orders/:orderId/payment-status
Response: {
  "v2PaymentStatus": "verified",
  "v2PaymentAmount": 25.50,
  "v2PaymentMethod": "venmo",
  "v2PaymentVerifiedAt": "2024-01-15T..."
}

// Resend payment request
POST /api/v1/orders/:orderId/resend-payment-request

// Get payment links
GET /api/v1/orders/:orderId/payment-links
Response: {
  "links": {
    "venmo": "venmo://...",
    "paypal": "https://paypal.me/...",
    "cashapp": "https://cash.app/..."
  },
  "qrCodes": {
    "venmo": "data:image/png;base64,...",
    "paypal": "data:image/png;base64,...",
    "cashapp": "data:image/png;base64,..."
  }
}</code></pre>
        </div>

        <div class="content-section" style="margin-top: 40px; text-align: center; color: #666;">
            <p>Last updated: January 2025 | Version 2.0</p>
            <p><a href="index.html">‚Üê Back to Documentation</a></p>
        </div>
    </div>
</body>
</html>