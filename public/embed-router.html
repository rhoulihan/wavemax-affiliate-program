<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveMAX Affiliate Program - Embedded Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
            overflow-x: hidden;
        }
        
        #app-container {
            width: 100%;
            min-height: 100vh;
            position: relative;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            font-size: 1.2rem;
            color: #666;
        }
        
        .error {
            padding: 20px;
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            color: #c00;
            margin: 20px;
            text-align: center;
        }
        
        iframe {
            width: 100%;
            border: none;
            display: block;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="loading">Loading...</div>
    </div>

    <script>
        // Embedded Application Router
        const EMBED_BASE_URL = 'https://wavemax.promo';
        const ALLOWED_ORIGINS = ['https://www.wavemaxlaundry.com', 'https://wavemaxlaundry.com'];
        
        // Route mapping
        const routes = {
            '/': '/iframe-embed.html',
            '/affiliate-register': '/affiliate-register-embed.html',
            '/affiliate-login': '/affiliate-login-embed.html',
            '/affiliate-dashboard': '/affiliate-dashboard-embed.html',
            '/affiliate-success': '/affiliate-success-embed.html',
            '/customer-register': '/customer-register-embed.html',
            '/customer-login': '/customer-login-embed.html',
            '/customer-dashboard': '/customer-dashboard-embed.html',
            '/customer-success': '/customer-success-embed.html',
            '/schedule-pickup': '/schedule-pickup-embed.html',
            '/order-confirmation': '/order-confirmation-embed.html'
        };
        
        let currentIframe = null;
        let messageQueue = [];
        
        // Get initial route from URL parameters
        function getInitialRoute() {
            const params = new URLSearchParams(window.location.search);
            const route = params.get('route') || '/';
            const queryString = params.toString();
            return { route, queryString };
        }
        
        // Load embedded page
        function loadPage(route, queryString = '') {
            const container = document.getElementById('app-container');
            const embedUrl = routes[route] || routes['/'];
            
            // Remove existing iframe
            if (currentIframe) {
                currentIframe.remove();
            }
            
            // Create new iframe
            currentIframe = document.createElement('iframe');
            currentIframe.src = `${EMBED_BASE_URL}${embedUrl}${queryString ? '?' + queryString : ''}`;
            currentIframe.style.height = '600px'; // Initial height
            currentIframe.setAttribute('loading', 'eager');
            currentIframe.setAttribute('allow', 'fullscreen');
            
            // Handle iframe load
            currentIframe.onload = function() {
                // Send any queued messages
                messageQueue.forEach(msg => {
                    currentIframe.contentWindow.postMessage(msg, EMBED_BASE_URL);
                });
                messageQueue = [];
                
                // Request initial height
                currentIframe.contentWindow.postMessage({
                    type: 'request-height'
                }, EMBED_BASE_URL);
            };
            
            // Handle iframe error
            currentIframe.onerror = function() {
                container.innerHTML = '<div class="error">Failed to load content. Please try again.</div>';
            };
            
            container.innerHTML = '';
            container.appendChild(currentIframe);
        }
        
        // Handle messages from embedded pages
        window.addEventListener('message', function(event) {
            // Verify origin
            if (event.origin !== EMBED_BASE_URL) return;
            
            const { type, data } = event.data;
            
            switch (type) {
                case 'navigate':
                    // Navigate to a new embedded page
                    if (data.url) {
                        const url = new URL(data.url, EMBED_BASE_URL);
                        const path = url.pathname.replace('.html', '').replace('-embed', '');
                        const route = routes[path] ? path : '/';
                        loadPage(route, url.search.substring(1));
                        
                        // Update parent URL if needed
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'update-url',
                                route: route,
                                queryString: url.search.substring(1)
                            }, '*');
                        }
                    }
                    break;
                    
                case 'resize':
                    // Adjust iframe height
                    if (currentIframe && data.height) {
                        currentIframe.style.height = data.height + 'px';
                    }
                    break;
                    
                case 'auth-status':
                    // Forward auth status to parent
                    if (window.parent !== window) {
                        window.parent.postMessage(event.data, '*');
                    }
                    break;
                    
                case 'open-external':
                    // Open external links in new tab
                    if (data.url) {
                        window.open(data.url, '_blank', 'noopener,noreferrer');
                    }
                    break;
                    
                case 'reload':
                    // Reload current page
                    if (currentIframe) {
                        currentIframe.src = currentIframe.src;
                    }
                    break;
                    
                case 'message':
                    // Display message to user (could integrate with parent's notification system)
                    if (window.parent !== window) {
                        window.parent.postMessage(event.data, '*');
                    }
                    break;
            }
        });
        
        // Handle messages from parent window
        if (window.parent !== window) {
            window.addEventListener('message', function(event) {
                // Only accept messages from allowed origins
                if (ALLOWED_ORIGINS.indexOf(event.origin) === -1 && event.origin !== window.location.origin) {
                    return;
                }
                
                const { type, data } = event.data;
                
                switch (type) {
                    case 'navigate':
                        // Navigate to specified route
                        if (data.route) {
                            loadPage(data.route, data.queryString || '');
                        }
                        break;
                        
                    case 'prefill':
                        // Queue message to prefill form data
                        messageQueue.push(event.data);
                        if (currentIframe && currentIframe.contentWindow) {
                            currentIframe.contentWindow.postMessage(event.data, EMBED_BASE_URL);
                        }
                        break;
                        
                    case 'auth-check':
                        // Forward auth check to embedded page
                        if (currentIframe && currentIframe.contentWindow) {
                            currentIframe.contentWindow.postMessage(event.data, EMBED_BASE_URL);
                        }
                        break;
                }
            });
        }
        
        // Auto-resize based on content
        function setupAutoResize() {
            // Observe DOM changes that might affect height
            const resizeObserver = new ResizeObserver(() => {
                if (currentIframe && currentIframe.contentWindow) {
                    currentIframe.contentWindow.postMessage({
                        type: 'request-height'
                    }, EMBED_BASE_URL);
                }
            });
            
            resizeObserver.observe(document.body);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const { route, queryString } = getInitialRoute();
            loadPage(route, queryString);
            setupAutoResize();
            
            // Notify parent that router is ready
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'router-ready',
                    routes: Object.keys(routes)
                }, '*');
            }
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', function(event) {
            const { route, queryString } = getInitialRoute();
            loadPage(route, queryString);
        });
    </script>
</body>
</html>