<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveMAX Laundry - Affiliate Login</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
        }
        .wavemax-blue {
            background-color: #1e3a8a;
        }
        .wavemax-light-blue {
            background-color: #3b82f6;
        }
        /* Minimal styling for iframe */
        .embed-container {
            max-width: 100%;
            margin: 0;
            padding: 16px;
        }
        /* Language switcher positioning */
        #language-switcher-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-white font-sans">
    <!-- Language Switcher -->
    <div id="language-switcher-container"></div>
    
    <!-- Login Form -->
    <div class="embed-container">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-md overflow-hidden">
            <div class="wavemax-blue text-white p-6">
                <h2 class="text-2xl font-bold" data-i18n="affiliate.login.title">Affiliate Login</h2>
                <p class="mt-2" data-i18n="affiliate.login.subtitle">Sign in to access your affiliate dashboard</p>
            </div>
            
            <!-- Social Login Section -->
            <div class="p-6 pb-0">
                <div id="socialLoginSection" class="bg-gray-50 p-4 rounded-lg mb-6" style="position: relative;">
                    <p class="text-gray-600 mb-4 text-center" data-i18n="affiliate.login.socialLogin">Sign in with your social media account</p>
                    <div class="grid grid-cols-3 gap-3">
                        <button type="button" id="googleLogin" class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                        </button>
                        
                        <button type="button" id="facebookLogin" class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition">
                            <svg class="w-5 h-5" fill="#1877F2" viewBox="0 0 24 24">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </button>
                        
                        <button type="button" id="linkedinLogin" class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition">
                            <svg class="w-5 h-5" fill="#0A66C2" viewBox="0 0 24 24">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-gray-50 text-gray-500" data-i18n="affiliate.login.orEmail">Or sign in with username and password</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="affiliateLoginForm" class="p-6 pt-0 space-y-6">
                
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 mb-2" data-i18n="common.labels.username">Username</label>
                    <input type="text" id="username" name="username" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label for="password" class="block text-gray-700 mb-2" data-i18n="common.labels.password">Password</label>
                    <input type="password" id="password" name="password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="remember" name="remember" class="h-4 w-4 text-blue-600">
                        <label for="remember" class="ml-2 text-sm text-gray-700" data-i18n="common.labels.rememberMe">Remember me</label>
                    </div>
                    <a href="#" class="text-sm text-blue-600 hover:underline" onclick="navigateParent('forgot-password'); return false;" data-i18n="common.labels.forgotPassword">Forgot password?</a>
                </div>
                
                <div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition" data-i18n="common.buttons.signIn">Sign In</button>
                </div>
            </form>
            
            <div class="bg-gray-50 p-6 border-t">
                <p class="text-sm text-gray-700 text-center">
                    <span data-i18n="affiliate.login.noAccount">Don't have an affiliate account?</span> 
                    <a href="#" class="text-blue-600 hover:underline" onclick="navigateParent('affiliate-register'); return false;" data-i18n="common.buttons.registerNow">Register now</a>
                </p>
            </div>
        </div>
    </div>

    <!-- i18n Scripts -->
    <script src="/assets/js/i18n.js"></script>
    <script src="/assets/js/language-switcher.js"></script>
    <script src="/assets/js/modal-utils.js"></script>
    <script src="/assets/js/csrf-utils.js"></script>
    <script src="/assets/js/swirl-spinner.js"></script>
    <script>
        // Initialize i18n
        document.addEventListener('DOMContentLoaded', async function() {
            await window.i18n.init({ debugMode: false });
            window.LanguageSwitcher.createSwitcher('language-switcher-container', {
                style: 'dropdown',
                showLabel: false
            });
        });
        
        console.log('ðŸš€ Affiliate login script starting...');
        // PostMessage communication with parent window
        function sendMessageToParent(type, data) {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: type,
                    source: 'wavemax-embed',
                    data: data
                }, '*');
            }
        }

        // Navigate parent frame
        function navigateParent(page) {
            sendMessageToParent('navigate', { page: page });
        }

        // Configuration for embedded environment
        const baseUrl = window.location.protocol + '//' + window.location.host;
        const isEmbedded = true;
        const csrfFetch = window.CsrfUtils && window.CsrfUtils.csrfFetch ? window.CsrfUtils.csrfFetch : fetch;
        
        console.log('ðŸ”§ Affiliate Login Configuration:', {
            baseUrl: baseUrl,
            isEmbedded: isEmbedded,
            hasCsrfUtils: !!window.CsrfUtils,
            csrfFetch: typeof csrfFetch
        });

        // Helper function to get translated spinner messages
        function getSpinnerMessage(key, params = {}) {
            // Default messages
            const defaults = {
                'spinner.connectingWith': 'Connecting with {{provider}}...',
                'spinner.pleaseWait': 'Please wait...'
            };
            
            // Try to get translation
            if (window.i18n && window.i18n.t) {
                const translated = window.i18n.t(key, params);
                // Check if we got an actual translation or just the key back
                if (translated && translated !== key && !translated.includes('.')) {
                    return translated;
                }
            }
            
            // Fallback to default message
            let defaultMsg = defaults[key] || key;
            // Replace parameters in default message
            if (params) {
                Object.keys(params).forEach(param => {
                    defaultMsg = defaultMsg.replace(`{{${param}}}`, params[param]);
                });
            }
            return defaultMsg;
        }

        // OAuth Social Login Functionality for Affiliates
        function handleAffiliateLogin(provider, event) {
            console.log(`Starting ${provider} social login for affiliate`);
            
            // Show spinner on the social login section
            const socialLoginSection = document.getElementById('socialLoginSection');
            let spinner = null;
            
            if (socialLoginSection && window.SwirlSpinner) {
                try {
                    console.log('[OAuth] Creating SwirlSpinner with overlay...');
                    const providerName = provider.charAt(0).toUpperCase() + provider.slice(1);
                    const message = getSpinnerMessage('spinner.connectingWith', { provider: providerName });
                    
                    spinner = new window.SwirlSpinner({
                        container: socialLoginSection,
                        size: 'default',
                        speed: 'normal',
                        overlay: true,
                        message: message
                    });
                    spinner.show();
                    console.log('[OAuth] Spinner shown successfully');
                } catch (error) {
                    console.error('[OAuth] Error creating spinner:', error);
                }
            } else {
                console.log('[OAuth] Cannot show spinner:', {
                    sectionFound: !!socialLoginSection,
                    swirlSpinnerAvailable: !!window.SwirlSpinner
                });
            }

            // For embedded context, use popup window to avoid iframe restrictions
            if (isEmbedded || window.self !== window.top) {
                // Generate unique session ID for database polling
                const sessionId = 'oauth_' + Date.now() + '_' + Math.random().toString(36).substring(2);
                console.log('Generated Affiliate Login OAuth session ID:', sessionId);
                
                const oauthUrl = `${baseUrl}/api/v1/auth/${provider}?popup=true&state=${sessionId}&t=${Date.now()}`;
                console.log('ðŸ”— Opening Affiliate Login OAuth URL:', oauthUrl);
                
                const popup = window.open(
                    oauthUrl, 
                    'affiliateSocialLogin',
                    'width=500,height=600,scrollbars=yes,resizable=yes'
                );
                
                console.log('Affiliate login popup opened:', {
                    'popup exists': !!popup,
                    'popup.closed': popup ? popup.closed : 'N/A'
                });
                
                if (!popup || popup.closed) {
                    // Hide spinner on error
                    if (spinner) {
                        spinner.hide();
                    }
                    modalAlert(window.i18n ? window.i18n.t('common.messages.popupBlocked') : 'Popup was blocked. Please allow popups for this site and try again.', 'Popup Blocked');
                    return;
                }
                
                // Database polling approach (more reliable than postMessage)
                let pollCount = 0;
                const maxPolls = 120; // 6 minutes max (120 * 3 seconds)
                let authResultReceived = false;
                
                console.log('Starting database polling for Affiliate Login OAuth result...');
                
                const pollForResult = setInterval(async () => {
                    pollCount++;
                    
                    try {
                        // Check if popup is closed
                        if (popup.closed) {
                            console.log('Affiliate login popup closed, continuing to poll for result...');
                        }
                        
                        // Poll the database for result
                        const response = await csrfFetch(`${baseUrl}/api/v1/auth/oauth-session/${sessionId}`);
                        
                        console.log('ðŸ” Affiliate login polling response:', {
                            ok: response.ok,
                            status: response.status,
                            statusText: response.statusText
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('ðŸ“Š Affiliate login response data:', data);
                            if (data.success && data.result) {
                                console.log('ðŸ“¨ Affiliate login OAuth result received from database:', data.result);
                                authResultReceived = true;
                                clearInterval(pollForResult);
                                
                                if (popup && !popup.closed) {
                                    popup.close();
                                }
                                
                                // Hide spinner since we got a result
                                if (spinner) {
                                    spinner.hide();
                                }
                                
                                // Handle the result
                                try {
                                    if (data.result.type === 'social-auth-login') {
                                        console.log('Processing affiliate social-auth-login from database');
                                        
                                        // Store token and affiliate data
                                        localStorage.setItem('affiliateToken', data.result.token);
                                        
                                        // Notify parent of successful login
                                        sendMessageToParent('login-success', {
                                            userType: 'affiliate',
                                            token: data.result.token
                                        });

                                        // Navigate to affiliate dashboard
                                        console.log('Redirecting to affiliate dashboard after social login');
                                        navigateParent('affiliate-dashboard');
                                        
                                    } else if (data.result.type === 'social-auth-success') {
                                        console.log('Affiliate does not exist, redirecting to registration');
                                        // New affiliate - redirect to registration with social token
                                        modalAlert(window.i18n ? window.i18n.t('common.messages.accountNotFound') : 'Account not found. You will be redirected to registration to create a new affiliate account.', 'Account Not Found');
                                        window.location.href = `/affiliate-register-embed.html?socialToken=${data.result.socialToken}&provider=${data.result.provider}`;
                                        
                                    } else if (data.result.type === 'social-auth-error') {
                                        console.log('Processing affiliate social-auth-error from database');
                                        modalAlert(data.result.message || (window.i18n ? window.i18n.t('common.messages.authenticationFailed') : 'Social authentication failed'), window.i18n ? window.i18n.t('common.messages.authenticationFailed') : 'Authentication Failed');
                                        
                                    } else {
                                        console.log('Unknown affiliate login result type:', data.result.type);
                                    }
                                } catch (resultError) {
                                    console.error('Error processing Affiliate Login OAuth result:', resultError);
                                    modalAlert(window.i18n ? window.i18n.t('common.messages.processingError') : 'Error processing authentication result', 'Processing Error');
                                }
                                return;
                            }
                        }
                        
                        // Check for timeout
                        if (pollCount > maxPolls) {
                            console.log('Affiliate login database polling timeout exceeded');
                            clearInterval(pollForResult);
                            if (popup && !popup.closed) {
                                popup.close();
                            }
                            // Hide spinner on timeout
                            if (spinner) {
                                spinner.hide();
                            }
                            modalAlert(window.i18n ? window.i18n.t('common.messages.authenticationTimeout') : 'Authentication timed out. Please try again.', window.i18n ? window.i18n.t('common.messages.authenticationTimeout') : 'Authentication Timeout');
                            return;
                        }
                        
                        // Log progress every 5 polls (15 seconds)
                        if (pollCount % 5 === 0) {
                            console.log(`ðŸ”„ Polling for Affiliate Login OAuth result... (${pollCount}/${maxPolls})`);
                        }
                        
                    } catch (error) {
                        // 404 means no result yet, continue polling
                        if (error.message && error.message.includes('404')) {
                            return;
                        }
                        
                        console.error('Error polling for Affiliate Login OAuth result:', error);
                        
                        // Don't stop polling for network errors, just log them
                        if (pollCount % 10 === 0) {
                            console.log('Network error during Affiliate Login polling, continuing...');
                        }
                    }
                }, 3000); // Poll every 3 seconds
            } else {
                // For non-embedded context, use direct navigation
                window.location.href = `${baseUrl}/api/v1/auth/${provider}`;
            }
        }

        // Setup OAuth button handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ” Setting up OAuth button handlers...');
            const googleLogin = document.getElementById('googleLogin');
            const facebookLogin = document.getElementById('facebookLogin');
            const linkedinLogin = document.getElementById('linkedinLogin');

            console.log('ðŸ” Found buttons:', {
                googleLogin: !!googleLogin,
                facebookLogin: !!facebookLogin,
                linkedinLogin: !!linkedinLogin
            });

            if (googleLogin) {
                console.log('âœ… Attaching Google login handler');
                googleLogin.addEventListener('click', function(e) {
                    console.log('ðŸ”´ Google login button clicked!');
                    handleAffiliateLogin('google', e);
                });
            } else {
                console.error('âŒ Google login button not found!');
            }

            if (facebookLogin) {
                facebookLogin.addEventListener('click', function(e) {
                    handleAffiliateLogin('facebook', e);
                });
            }

            if (linkedinLogin) {
                linkedinLogin.addEventListener('click', function(e) {
                    handleAffiliateLogin('linkedin', e);
                });
            }
        });

        // Form submission
        document.getElementById('affiliateLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Send login status to parent
            sendMessageToParent('form-submit', { form: 'affiliate-login' });

            // API call with full URL
            fetch(`${baseUrl}/api/v1/auth/affiliate/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ username, password })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Login failed');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Store token
                    localStorage.setItem('affiliateToken', data.token);
                    localStorage.setItem('currentAffiliate', JSON.stringify(data.affiliate));

                    // Notify parent of successful login
                    sendMessageToParent('login-success', {
                        userType: 'affiliate',
                        affiliateId: data.affiliate.affiliateId
                    });

                    // Navigate to dashboard
                    navigateParent('affiliate-dashboard');
                } else {
                    sendMessageToParent('login-error', {
                        message: data.message || 'Login failed'
                    });
                    modalAlert(data.message || (window.i18n ? window.i18n.t('common.messages.loginFailed') : 'Login failed. Please check your credentials and try again.'), window.i18n ? window.i18n.t('common.messages.loginFailed') : 'Login Failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                sendMessageToParent('login-error', {
                    message: 'Login failed. Please check your credentials and try again.'
                });
                modalAlert(window.i18n ? window.i18n.t('common.messages.loginFailed') : 'Login failed. Please check your credentials and try again.', window.i18n ? window.i18n.t('common.messages.error') : 'Login Error');
            });
        });

        // Notify parent that iframe is loaded
        window.addEventListener('load', function() {
            sendMessageToParent('iframe-loaded', { page: 'affiliate-login' });
        });
    </script>
</body>
</html>