<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Iframe Window Detection</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        iframe { width: 100%; height: 400px; border: 2px solid #333; }
    </style>
</head>
<body>
    <h1>Test Window Detection from Iframe</h1>
    
    <div class="test-section">
        <h2>Direct Test (Not in iframe)</h2>
        <button onclick="testDirect()">Test Window Opening</button>
        <div id="direct-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>Iframe Test</h2>
        <p>This iframe loads the same domain content that tries to open windows:</p>
        <iframe id="test-iframe" src="about:blank"></iframe>
    </div>
    
    <script>
        function log(id, msg) {
            const el = document.getElementById(id);
            el.textContent += `${new Date().toISOString().substring(11, 23)} ${msg}\n`;
        }
        
        function testDirect() {
            log('direct-log', 'Opening window directly...');
            
            // Test 1: Open empty window then navigate
            const win1 = window.open('', 'TestWin1', 'width=400,height=300');
            log('direct-log', `Empty window: closed=${win1.closed}`);
            
            if (win1) {
                win1.location.href = '/test-payment';
                setTimeout(() => {
                    try {
                        log('direct-log', `After navigation: closed=${win1.closed}`);
                    } catch (e) {
                        log('direct-log', `Error checking: ${e.message}`);
                    }
                }, 1000);
            }
            
            // Test 2: Open with URL directly
            setTimeout(() => {
                const win2 = window.open('/test-payment', 'TestWin2', 'width=400,height=300');
                log('direct-log', `Direct URL window: closed=${win2?.closed}`);
            }, 2000);
        }
        
        // Create iframe content
        const iframeContent = `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        button { padding: 10px 20px; margin: 5px; }
        .log { background: white; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h3>Iframe Content (${window.location.origin})</h3>
    <button onclick="testFromIframe()">Test Window Opening from Iframe</button>
    <div id="iframe-log" class="log"></div>
    
    <script>
        function log(msg) {
            const el = document.getElementById('iframe-log');
            el.textContent += new Date().toISOString().substring(11, 23) + ' ' + msg + '\\n';
            // Also send to parent
            window.parent.postMessage({ type: 'log', msg: msg }, '*');
        }
        
        function testFromIframe() {
            log('Testing from iframe...');
            log('Iframe origin: ' + window.location.origin);
            log('Parent origin: ' + (window.parent !== window ? 'different window' : 'same window'));
            
            // Test 1: Open empty window then navigate
            try {
                const win1 = window.open('', 'IframeTestWin1', 'width=400,height=300');
                log('Empty window: ' + (win1 ? 'opened' : 'blocked') + ', closed=' + (win1?.closed));
                
                if (win1) {
                    // Try different navigation methods
                    const testUrl = window.location.origin + '/test-payment';
                    log('Navigating to: ' + testUrl);
                    
                    // Method 1: Direct assignment
                    win1.location.href = testUrl;
                    
                    setTimeout(() => {
                        try {
                            log('After nav (1s): closed=' + win1.closed + ', can focus=' + !!(win1.focus));
                            win1.focus();
                        } catch (e) {
                            log('Error after nav: ' + e.message);
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        try {
                            log('After nav (3s): closed=' + win1.closed);
                        } catch (e) {
                            log('Error after 3s: ' + e.message);
                        }
                    }, 3000);
                }
            } catch (e) {
                log('Error opening empty window: ' + e.message);
            }
            
            // Test 2: Open with URL directly
            setTimeout(() => {
                try {
                    const win2 = window.open('/test-payment', 'IframeTestWin2', 'width=400,height=300');
                    log('Direct URL window: ' + (win2 ? 'opened' : 'blocked') + ', closed=' + (win2?.closed));
                    
                    if (win2) {
                        setTimeout(() => {
                            try {
                                log('Direct URL after 1s: closed=' + win2.closed);
                            } catch (e) {
                                log('Direct URL error: ' + e.message);
                            }
                        }, 1000);
                    }
                } catch (e) {
                    log('Error opening direct URL: ' + e.message);
                }
            }, 5000);
            
            // Test 3: Test with absolute URL
            setTimeout(() => {
                try {
                    const absoluteUrl = window.location.protocol + '//' + window.location.host + '/test-payment';
                    log('Testing absolute URL: ' + absoluteUrl);
                    const win3 = window.open(absoluteUrl, 'IframeTestWin3', 'width=400,height=300');
                    log('Absolute URL window: ' + (win3 ? 'opened' : 'blocked') + ', closed=' + (win3?.closed));
                } catch (e) {
                    log('Error opening absolute URL: ' + e.message);
                }
            }, 8000);
        }
        
        // Listen for messages from opened windows
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'test-window-loaded') {
                log('Received message from test window: ' + JSON.stringify(e.data));
            }
        });
    <\/script>
</body>
</html>
        `;
        
        // Write content to iframe
        const iframe = document.getElementById('test-iframe');
        iframe.onload = function() {
            console.log('Iframe loaded');
        };
        iframe.srcdoc = iframeContent;
        
        // Listen for logs from iframe
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'log') {
                console.log('[Iframe Log]', e.data.msg);
            }
        });
    </script>
</body>
</html>