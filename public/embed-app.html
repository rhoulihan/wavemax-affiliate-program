<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveMAX Affiliate Program</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        #app-container {
            width: 100%;
            min-height: 600px;
            margin: 0;
            padding: 0;
        }
        
        /* Remove any top margins/padding from first child elements */
        #app-container > *:first-child {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            font-size: 1.2rem;
            color: #666;
        }
        
        .error {
            padding: 20px;
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            color: #c00;
            margin: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="loading">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Loading...
        </div>
    </div>

    <script>
        // Single page embedded application
        const BASE_URL = 'https://wavemax.promo';
        const EMBED_PAGES = {
            '/': '/embed-landing.html',
            '/landing': '/embed-landing.html',
            '/affiliate-register': '/affiliate-register-embed.html',
            '/affiliate-login': '/affiliate-login-embed.html',
            '/affiliate-dashboard': '/affiliate-dashboard-embed.html',
            '/affiliate-success': '/affiliate-success-embed.html',
            '/customer-register': '/customer-register-embed.html',
            '/customer-login': '/customer-login-embed.html',
            '/customer-dashboard': '/customer-dashboard-embed.html',
            '/customer-success': '/customer-success-embed.html',
            '/schedule-pickup': '/schedule-pickup-embed.html',
            '/order-confirmation': '/order-confirmation-embed.html'
        };
        
        let currentRoute = '/';
        
        // Get route from URL parameter
        function getRouteFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('route') || '/';
        }
        
        // Load page content
        async function loadPage(route) {
            const container = document.getElementById('app-container');
            const pagePath = EMBED_PAGES[route] || EMBED_PAGES['/'];
            
            try {
                container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>';
                
                const response = await fetch(BASE_URL + pagePath);
                if (!response.ok) throw new Error('Failed to load page');
                
                let html = await response.text();
                
                // Extract head content for styles
                const headMatch = html.match(/<head[^>]*>([\s\S]*)<\/head>/i);
                const bodyMatch = html.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                
                if (headMatch && bodyMatch) {
                    // Extract styles and links from head
                    const headContent = headMatch[1];
                    const styles = headContent.match(/<style[^>]*>[\s\S]*?<\/style>/gi) || [];
                    const styleLinks = headContent.match(/<link[^>]*rel=["']stylesheet["'][^>]*>/gi) || [];
                    
                    // Get body content
                    let bodyContent = bodyMatch[1];
                    
                    // Remove script tags to prevent duplicate execution
                    bodyContent = bodyContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                    
                    // Update relative URLs to absolute
                    bodyContent = bodyContent.replace(/src=["'](?!http|\/\/)([^"']+)["']/g, `src="${BASE_URL}/$1"`);
                    bodyContent = bodyContent.replace(/href=["'](?!http|\/\/|#)([^"']+)["']/g, `href="${BASE_URL}/$1"`);
                    
                    // Add external stylesheets to head if not already present
                    styleLinks.forEach(link => {
                        // Update relative paths in link tags
                        const updatedLink = link.replace(/href=["'](?!http|\/\/)([^"']+)["']/g, `href="${BASE_URL}/$1"`);
                        // Check if this stylesheet is already in the document
                        const linkHref = updatedLink.match(/href=["']([^"']+)["']/);
                        if (linkHref && !document.querySelector(`link[href="${linkHref[1]}"]`)) {
                            const linkElement = document.createElement('div');
                            linkElement.innerHTML = updatedLink;
                            document.head.appendChild(linkElement.firstChild);
                        }
                    });
                    
                    // Combine styles and body content
                    html = styles.join('\n') + bodyContent;
                }
                
                container.innerHTML = html;
                currentRoute = route;
                
                // Initialize navigation for the loaded content
                initializeNavigation();
                
                // Update parent URL if in iframe
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'route-changed',
                        data: { route: route }
                    }, '*');
                }
                
                // Send height to parent
                sendHeight();
                
            } catch (error) {
                console.error('Error loading page:', error);
                container.innerHTML = '<div class="error">Failed to load content. Please try again.</div>';
            }
        }
        
        // Initialize navigation handlers
        function initializeNavigation() {
            // Handle data-navigate links
            document.querySelectorAll('[data-navigate]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const route = this.getAttribute('data-navigate');
                    navigateTo(route);
                });
            });
            
            // Handle regular links that should navigate
            document.querySelectorAll('a[href^="/"]').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !link.hasAttribute('target')) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const route = href.replace('.html', '').replace('-embed', '');
                        navigateTo(route);
                    });
                }
            });
            
            // Load external navigation script if exists
            const embedNavScript = document.createElement('script');
            embedNavScript.src = BASE_URL + '/assets/js/embed-navigation.js';
            embedNavScript.onload = function() {
                console.log('Embed navigation script loaded');
            };
            document.body.appendChild(embedNavScript);
            
            // Load page-specific scripts
            loadPageScripts();
        }
        
        // Load page-specific scripts
        function loadPageScripts() {
            // Clean up old scripts first (except embed-navigation.js)
            const existingScripts = document.querySelectorAll('script[src*="/assets/js/"]');
            existingScripts.forEach(script => {
                if (!script.src.includes('embed-navigation.js')) {
                    script.remove();
                }
            });
            
            // Map of routes to their required scripts
            const pageScripts = {
                '/affiliate-register': ['/assets/js/errorHandler.js', '/assets/js/affiliate-register-init.js'],
                '/affiliate-login': ['/assets/js/errorHandler.js', '/assets/js/affiliate-login-init.js'],
                '/affiliate-dashboard': ['/assets/js/errorHandler.js', '/assets/js/affiliate-dashboard-init.js'],
                '/affiliate-success': ['/assets/js/affiliate-success-init.js'],
                '/customer-register': ['/assets/js/errorHandler.js', '/assets/js/customer-register.js'],
                '/customer-login': ['/assets/js/errorHandler.js', '/assets/js/customer-login-embed.js'],
                '/customer-dashboard': ['/assets/js/errorHandler.js', '/assets/js/customer-dashboard.js'],
                '/customer-success': ['/assets/js/customer-success.js'],
                '/schedule-pickup': ['/assets/js/errorHandler.js', '/assets/js/schedule-pickup.js'],
                '/order-confirmation': ['/assets/js/errorHandler.js', '/assets/js/order-confirmation.js']
            };
            
            const scripts = pageScripts[currentRoute] || [];
            
            // Set embed config before loading scripts
            window.EMBED_CONFIG = {
                baseUrl: BASE_URL,
                isEmbedded: true
            };
            
            // Load scripts sequentially
            let scriptIndex = 0;
            function loadNextScript() {
                if (scriptIndex < scripts.length) {
                    const script = document.createElement('script');
                    script.src = BASE_URL + scripts[scriptIndex];
                    script.setAttribute('data-page-script', 'true');
                    script.onload = function() {
                        console.log('Loaded script:', scripts[scriptIndex]);
                        scriptIndex++;
                        loadNextScript();
                    };
                    script.onerror = function() {
                        console.error('Failed to load script:', scripts[scriptIndex]);
                        scriptIndex++;
                        loadNextScript();
                    };
                    document.body.appendChild(script);
                }
            }
            
            loadNextScript();
        }
        
        // Navigate to a route
        function navigateTo(route, params = {}) {
            console.log('Navigating to:', route, 'with params:', params);
            
            // Update URL parameter
            const url = new URL(window.location);
            url.searchParams.set('route', route);
            
            // Add any additional parameters
            Object.keys(params).forEach(key => {
                url.searchParams.set(key, params[key]);
            });
            
            window.history.pushState({}, '', url);
            
            // Load the new page
            loadPage(route);
        }
        
        // Send height to parent window
        function sendHeight() {
            if (window.parent !== window) {
                const height = Math.max(
                    document.body.scrollHeight,
                    document.body.offsetHeight,
                    document.documentElement.scrollHeight,
                    document.documentElement.offsetHeight
                );
                
                window.parent.postMessage({
                    type: 'resize',
                    data: { height: height }
                }, '*');
            }
        }
        
        // Handle messages from embedded pages
        window.addEventListener('message', function(event) {
            console.log('Message received:', event);
            console.log('Message origin:', event.origin);
            console.log('Message data:', event.data);
            console.log('BASE_URL:', BASE_URL);
            console.log('window.location.origin:', window.location.origin);
            
            // Allow messages from same origin or from within iframes
            // For now, let's be more permissive to debug
            // if (event.origin !== BASE_URL && event.origin !== window.location.origin) return;
            
            const { type, data } = event.data;
            console.log('Message type:', type);
            console.log('Message data object:', data);
            
            if (type === 'navigate' && data) {
                // Handle navigation request
                if (data.url) {
                    // Old format with just URL
                    const route = data.url.startsWith('/') ? data.url : '/' + data.url;
                    console.log('Navigation request received:', route);
                    navigateTo(route);
                } else if (data.page) {
                    // New format with page and optional params
                    const route = data.page.startsWith('/') ? data.page : '/' + data.page;
                    console.log('Navigation request received:', route, 'with params:', data.params);
                    navigateTo(route, data.params || {});
                }
            }
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', function() {
            const route = getRouteFromUrl();
            loadPage(route);
        });
        
        // Monitor content changes for height updates
        const resizeObserver = new ResizeObserver(() => {
            sendHeight();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const initialRoute = getRouteFromUrl();
            loadPage(initialRoute);
            
            // Start observing body for size changes
            resizeObserver.observe(document.body);
        });
        
        // Also send height on window resize
        window.addEventListener('resize', sendHeight);
    </script>
</body>
</html>