
> wavemax-affiliate-program@1.0.0 test
> jest --runInBand

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:11.586Z"}
[0mGET /api/csrf-token [32m200[0m 6.706 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:12.218Z"}
[0mPOST /api/v1/customers/register [32m201[0m 203.161 ms - 266[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:13.010Z"}
[0mGET /api/csrf-token [32m200[0m 1.624 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:13.335Z"}
[0mPOST /api/v1/customers/register [33m400[0m 29.194 ms - 50[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:13.842Z"}
[0mGET /api/csrf-token [32m200[0m 1.235 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:14.191Z"}
[0mPOST /api/v1/customers/register [33m400[0m 69.221 ms - 62[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:14.776Z"}
[0mGET /api/csrf-token [32m200[0m 1.102 ms - 52[0m
[34mdebug[39m: POST /api/v1/customers/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:15.130Z"}
[0mPOST /api/v1/customers/register [33m400[0m 58.073 ms - 62[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:15.676Z"}
[0mGET /api/csrf-token [32m200[0m 1.455 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:16.018Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 91.326 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:16.589Z"}
[0mGET /api/csrf-token [32m200[0m 1.342 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:16.904Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 84.072 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:17.466Z"}
[0mGET /api/csrf-token [32m200[0m 1.252 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:17.778Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 81.089 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:18.339Z"}
[0mGET /api/csrf-token [32m200[0m 0.980 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:18.640Z"}
[0mGET /api/v1/customers/CUST123/profile [32m200[0m 81.904 ms - 90[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:19.197Z"}
[0mGET /api/csrf-token [32m200[0m 0.835 ms - 52[0m
[34mdebug[39m: PUT /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:19.530Z"}
[0mPUT /api/v1/customers/CUST123/profile [33m404[0m 1.511 ms - 128[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:20.016Z"}
[0mGET /api/csrf-token [32m200[0m 1.142 ms - 52[0m
[34mdebug[39m: PUT /api/v1/customers/CUST123/profile {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:20.338Z"}
[0mPUT /api/v1/customers/CUST123/profile [33m404[0m 1.099 ms - 128[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:20.818Z"}
[0mGET /api/csrf-token [32m200[0m 1.179 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/orders?page=1&limit=10 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:21.189Z"}
[0mGET /api/v1/customers/CUST123/orders?page=1&limit=10 [32m200[0m 87.745 ms - 582[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:21.771Z"}
[0mGET /api/csrf-token [32m200[0m 0.990 ms - 52[0m
[34mdebug[39m: GET /api/v1/customers/CUST123/orders?status=delivered {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:22.126Z"}
[0mGET /api/v1/customers/CUST123/orders?status=delivered [32m200[0m 84.039 ms - 340[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:22.692Z"}
[0mGET /api/csrf-token [32m200[0m 1.171 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:23.490Z"}
[0mGET /api/csrf-token [32m200[0m 1.108 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:24.276Z"}
[0mGET /api/csrf-token [32m200[0m 1.116 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:25.143Z"}
[0mGET /api/csrf-token [32m200[0m 1.208 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/customers/CUST123/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:25.517Z"}
  console.log
    CSRF Debug - Path: /api/v1/customers/CUST123/delete-all-data

      at log (server.js:262:13)

  console.log
    CSRF Debug - Session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:44:25.520Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server.js:263:13)

  console.log
    CSRF Debug - Headers: {
      host: '127.0.0.1:38401',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcyMTQ5MTg3MDEzODZmZTVkYjA1MyIsImN1c3RvbWVySWQiOiJDVVNUMTIzIiwicm9sZSI6ImN1c3RvbWVyIiwiaWF0IjoxNzQ4NDQzNDY1fQ.5oqZLIoFv59YL90cKfvv1-EQsiElDVjgZGbeRQWZp2o',
      'x-csrf-token': 'QXcpiWzn-yiXKCbZvov5qU8t3UCIwysJLnjY',
      connection: 'close'
    }

      at log (server.js:264:13)

  console.log
    CSRF Debug - Body: {}

      at log (server.js:265:13)

  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/customers/CUST123/delete-all-data

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: DELETE

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"DELETE","path":"/api/v1/customers/CUST123/delete-all-data","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:44:25.619Z","userId":null}
[0mDELETE /api/v1/customers/CUST123/delete-all-data [33m403[0m 103.639 ms - -[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:26.141Z"}
[0mGET /api/csrf-token [32m200[0m 1.165 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/customers/CUST123/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:26.444Z"}
  console.log
    CSRF Debug - Path: /api/v1/customers/CUST123/delete-all-data

      at log (server.js:262:13)

  console.log
    CSRF Debug - Session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:44:26.445Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server.js:263:13)

  console.log
    CSRF Debug - Headers: {
      host: '127.0.0.1:37361',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcyMTRhMTg3MDEzODZmZTVkYjA3MSIsImN1c3RvbWVySWQiOiJDVVNUMTIzIiwicm9sZSI6ImN1c3RvbWVyIiwiaWF0IjoxNzQ4NDQzNDY2fQ.OVZRGlSYCKEugTMCwxp9uNXG62mQTi8uGzPfimeT1Og',
      'x-csrf-token': 'Raar7ihk-IuMfA6ofN7lXmlKLiSQh_so80xQ',
      connection: 'close'
    }

      at log (server.js:264:13)

  console.log
    CSRF Debug - Body: {}

      at log (server.js:265:13)

  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/customers/CUST123/delete-all-data

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: DELETE

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"DELETE","path":"/api/v1/customers/CUST123/delete-all-data","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:44:26.509Z","userId":null}
[0mDELETE /api/v1/customers/CUST123/delete-all-data [33m403[0m 64.898 ms - 48[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:27.041Z"}
[0mGET /api/csrf-token [32m200[0m 1.519 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/customers/CUST123/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:27.449Z"}
  console.log
    CSRF Debug - Path: /api/v1/customers/CUST123/delete-all-data

      at log (server.js:262:13)

  console.log
    CSRF Debug - Session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:44:27.450Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server.js:263:13)

  console.log
    CSRF Debug - Headers: {
      host: '127.0.0.1:38599',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcyMTRiMTg3MDEzODZmZTVkYjA4ZCIsImN1c3RvbWVySWQiOiJDVVNUNDU2Iiwicm9sZSI6ImN1c3RvbWVyIiwiaWF0IjoxNzQ4NDQzNDY3fQ.FYw5B0wAFGNBGaLQE8ibMmwmZZUbQVYaDQpuTDHj3co',
      'x-csrf-token': 'L0W9ICco-ZnUXafEj540JM7_mcSOLMUEWDEo',
      connection: 'close'
    }

      at log (server.js:264:13)

  console.log
    CSRF Debug - Body: {}

      at log (server.js:265:13)

  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/customers/CUST123/delete-all-data

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: DELETE

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"DELETE","path":"/api/v1/customers/CUST123/delete-all-data","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:44:27.513Z","userId":null}
[0mDELETE /api/v1/customers/CUST123/delete-all-data [33m403[0m 64.647 ms - -[0m
FAIL tests/integration/customer.test.js (24.301 s)
  Customer Integration Tests
    POST /api/v1/customers/register
      ✓ should register a new customer (1471 ms)
      ✓ should fail with invalid affiliate ID (833 ms)
      ✓ should fail with duplicate email (933 ms)
      ✓ should fail with duplicate username (901 ms)
    GET /api/v1/customers/:customerId/profile
      ✕ should return customer profile for authenticated customer (912 ms)
      ✓ should return customer profile for affiliate (877 ms)
      ✕ should fail for unauthorized customer (873 ms)
      ✕ should fail without authentication (856 ms)
    PUT /api/v1/customers/:customerId/profile
      ✕ should update customer profile (818 ms)
      ✕ should not update protected fields (802 ms)
    GET /api/v1/customers/:customerId/orders
      ✕ should return customer orders with pagination (955 ms)
      ✓ should filter orders by status (921 ms)
    POST /api/v1/customers/report-lost-bag
      ✕ should report lost bag (795 ms)
      ✕ should fail for non-existent bag (784 ms)
      ✕ should fail for unauthorized bag report (865 ms)
    PUT /api/v1/customers/:customerId/password
      ○ skipped should update customer password
      ○ skipped should fail with incorrect current password
      ○ skipped should fail with weak new password
    GET /api/v1/customers/:customerId/bags
      ○ skipped should return customer bags
      ○ skipped should filter bags by status
      ○ skipped should allow affiliate to view customer bags
    GET /api/v1/customers/:customerId/dashboard
      ○ skipped should return customer dashboard statistics
      ○ skipped should return monthly statistics
      ○ skipped should allow affiliate to view customer dashboard
    DELETE /api/v1/customers/:customerId/delete-all-data
      ✕ should delete all customer data in development environment (995 ms)
      ✕ should reject deletion in production environment (902 ms)
      ✕ should reject unauthorized deletion (981 ms)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/profile › should return customer profile for authenticated customer

    expect(received).toMatchObject(expected)

    - Expected  - 12
    + Received  +  0

      Object {
        "customer": Object {
    -     "address": "456 Oak Ave",
    -     "affiliate": Object {
    -       "affiliateId": "AFF123",
    -       "deliveryFee": 5.99,
    -       "name": "John Doe",
    -     },
    -     "city": "Austin",
          "customerId": "CUST123",
    -     "email": "jane@example.com",
          "firstName": "Jane",
          "lastName": "Smith",
    -     "phone": "555-987-6543",
    -     "serviceFrequency": "weekly",
    -     "state": "TX",
    -     "zipCode": "78702",
        },
        "success": true,
      }

      204 |
      205 |       expect(response.status).toBe(200);
    > 206 |       expect(response.body).toMatchObject({
          |                             ^
      207 |         success: true,
      208 |         customer: {
      209 |           customerId: 'CUST123',

      at Object.toMatchObject (tests/integration/customer.test.js:206:29)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/profile › should fail for unauthorized customer

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      251 |         .set('Authorization', `Bearer ${otherCustomerToken}`);
      252 |
    > 253 |       expect(response.status).toBe(403);
          |                               ^
      254 |       expect(response.body).toMatchObject({
      255 |         success: false,
      256 |         message: 'Unauthorized'

      at Object.toBe (tests/integration/customer.test.js:253:31)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/profile › should fail without authentication

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      262 |         .get('/api/v1/customers/CUST123/profile');
      263 |
    > 264 |       expect(response.status).toBe(401);
          |                               ^
      265 |     });
      266 |   });
      267 |

      at Object.toBe (tests/integration/customer.test.js:264:31)

  ● Customer Integration Tests › PUT /api/v1/customers/:customerId/profile › should update customer profile

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      278 |         });
      279 |
    > 280 |       expect(response.status).toBe(200);
          |                               ^
      281 |       expect(response.body).toMatchObject({
      282 |         success: true,
      283 |         message: 'Customer profile updated successfully!'

      at Object.toBe (tests/integration/customer.test.js:280:31)

  ● Customer Integration Tests › PUT /api/v1/customers/:customerId/profile › should not update protected fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      303 |         });
      304 |
    > 305 |       expect(response.status).toBe(200);
          |                               ^
      306 |
      307 |       // Verify protected fields were not updated
      308 |       const customer = await Customer.findOne({ customerId: 'CUST123' });

      at Object.toBe (tests/integration/customer.test.js:305:31)

  ● Customer Integration Tests › GET /api/v1/customers/:customerId/orders › should return customer orders with pagination

    expect(received).toMatchObject(expected)

    - Expected  - 2
    + Received  + 0

    @@ -6,12 +6,10 @@
          ObjectContaining {
            "orderId": "ORD002",
          },
        ],
        "pagination": Object {
    -     "currentPage": 1,
          "pages": 1,
    -     "perPage": 10,
          "total": 2,
        },
        "success": true,
      }

      357 |
      358 |       expect(response.status).toBe(200);
    > 359 |       expect(response.body).toMatchObject({
          |                             ^
      360 |         success: true,
      361 |         orders: expect.arrayContaining([
      362 |           expect.objectContaining({ orderId: 'ORD001' }),

      at Object.toMatchObject (tests/integration/customer.test.js:359:29)

  ● Customer Integration Tests › POST /api/v1/customers/report-lost-bag › should report lost bag

    ValidationError: Bag validation failed: barcode: Path `barcode` is required., status: `active` is not a valid enum value for path `status`.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Customer Integration Tests › POST /api/v1/customers/report-lost-bag › should fail for non-existent bag

    ValidationError: Bag validation failed: barcode: Path `barcode` is required., status: `active` is not a valid enum value for path `status`.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Customer Integration Tests › POST /api/v1/customers/report-lost-bag › should fail for unauthorized bag report

    ValidationError: Bag validation failed: barcode: Path `barcode` is required., status: `active` is not a valid enum value for path `status`.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Customer Integration Tests › DELETE /api/v1/customers/:customerId/delete-all-data › should delete all customer data in development environment

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      744 |         .set('X-CSRF-Token', csrfToken);
      745 |
    > 746 |       expect(response.status).toBe(200);
          |                               ^
      747 |       expect(response.body).toMatchObject({
      748 |         success: true,
      749 |         message: 'All data has been deleted successfully'

      at Object.toBe (tests/integration/customer.test.js:746:31)

  ● Customer Integration Tests › DELETE /api/v1/customers/:customerId/delete-all-data › should reject deletion in production environment

    expect(received).toMatchObject(expected)

    - Expected  - 1
    + Received  + 1

      Object {
    -   "message": "This operation is not allowed in production",
    +   "message": "invalid csrf token",
        "success": false,
      }

      774 |
      775 |       expect(response.status).toBe(403);
    > 776 |       expect(response.body).toMatchObject({
          |                             ^
      777 |         success: false,
      778 |         message: 'This operation is not allowed in production'
      779 |       });

      at Object.toMatchObject (tests/integration/customer.test.js:776:29)

  ● Customer Integration Tests › DELETE /api/v1/customers/:customerId/delete-all-data › should reject unauthorized deletion

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      821 |       // Since the controller uses req.user.customerId, not the URL param,
      822 |       // this will succeed and delete CUST456's data
    > 823 |       expect(response.status).toBe(200);
          |                               ^
      824 |       expect(response.body).toMatchObject({
      825 |         success: true,
      826 |         message: 'All data has been deleted successfully'

      at Object.toBe (tests/integration/customer.test.js:823:31)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:29.381Z"}
[0mGET /api/csrf-token [32m200[0m 2.736 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:29.879Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:44:30.036Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 157.489 ms - 509[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:30.550Z"}
[0mGET /api/csrf-token [32m200[0m 3.334 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:30.809Z"}
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:30.888Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 79.578 ms - 58[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:31.371Z"}
[0mGET /api/csrf-token [32m200[0m 1.010 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:31.540Z"}
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"User not found","success":false,"timestamp":"2025-05-28T14:44:31.572Z","userType":"affiliate","username":"nonexistent"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 32.039 ms - 58[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:32.039Z"}
[0mGET /api/csrf-token [32m200[0m 0.976 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/customer/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:32.353Z"}
  console.log
    Customer affiliateId: AFF123

      at log (server/controllers/authController.js:465:13)

  console.log
    Found affiliate: AFF123

      at log (server/controllers/authController.js:466:13)

  console.log
    Affiliate delivery fee: 5.99

      at log (server/controllers/authController.js:467:13)

  console.log
    Sending customer login response: {
      "customerId": "CUST123",
      "firstName": "Jane",
      "lastName": "Smith",
      "email": "jane@example.com",
      "phone": "555-987-6543",
      "address": "456 Oak Ave",
      "city": "Austin",
      "state": "TX",
      "zipCode": "78702",
      "affiliateId": "AFF123",
      "affiliate": {
        "affiliateId": "AFF123",
        "name": "John Doe",
        "deliveryFee": 5.99
      }
    }

      at log (server/controllers/authController.js:499:13)

[0mPOST /api/v1/auth/customer/login [32m200[0m 176.516 ms - 632[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:33.018Z"}
[0mGET /api/csrf-token [32m200[0m 1.002 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:33.268Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:44:33.410Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 142.504 ms - 509[0m
[34mdebug[39m: GET /api/v1/auth/verify {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:33.416Z"}
[0mGET /api/v1/auth/verify [32m200[0m 2.003 ms - 99[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:33.913Z"}
[0mGET /api/csrf-token [32m200[0m 1.831 ms - 52[0m
[34mdebug[39m: GET /api/v1/auth/verify {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:34.081Z"}
[0mGET /api/v1/auth/verify [33m401[0m 1.186 ms - 43[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:34.550Z"}
[0mGET /api/csrf-token [32m200[0m 0.995 ms - 52[0m
[34mdebug[39m: GET /api/v1/auth/verify {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:34.726Z"}
[0mGET /api/v1/auth/verify [33m401[0m 0.951 ms - 47[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:35.210Z"}
[0mGET /api/csrf-token [32m200[0m 0.857 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:35.456Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:44:35.595Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 140.985 ms - 509[0m
[34mdebug[39m: POST /api/v1/auth/refresh-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:35.600Z"}
[0mPOST /api/v1/auth/refresh-token [32m200[0m 144.402 ms - 409[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:36.250Z"}
[0mGET /api/csrf-token [32m200[0m 2.308 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/refresh-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:36.413Z"}
[0mPOST /api/v1/auth/refresh-token [33m400[0m 1.349 ms - 89[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:36.886Z"}
[0mGET /api/csrf-token [32m200[0m 2.598 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/refresh-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.178Z"}
[0mPOST /api/v1/auth/refresh-token [33m401[0m 27.093 ms - 62[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.687Z"}
[0mGET /api/csrf-token [32m200[0m 0.981 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.956Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.958Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.959Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.961Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.965Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.966Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.967Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.971Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.972Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.975Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.976Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.978Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.979Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.980Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.981Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.982Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.985Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.986Z"}
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.987Z"}
[0mPOST /api/v1/auth/affiliate/login [33m429[0m 0.735 ms - 77[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.988Z"}
[0mPOST /api/v1/auth/affiliate/login [33m429[0m 0.794 ms - 77[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:37.994Z"}
[0mPOST /api/v1/auth/affiliate/login [33m429[0m 0.671 ms - 77[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.049Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 93.339 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.107Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 149.407 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.161Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 202.124 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.212Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 252.183 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.279Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 314.198 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.328Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 361.743 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.388Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 421.132 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.463Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 490.941 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.523Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 545.821 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.574Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 595.508 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.633Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 653.169 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.686Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 705.132 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.736Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 754.839 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.830Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 845.738 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.887Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 916.325 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:38.961Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 976.075 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:39.120Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 1148.615 ms - 58[0m
info: undefined {"eventType":"LOGIN_FAILED","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":"Invalid password","success":false,"timestamp":"2025-05-28T14:44:39.184Z","userType":"affiliate","username":"johndoe"}
[0mPOST /api/v1/auth/affiliate/login [33m401[0m 1209.981 ms - 58[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:39.665Z"}
[0mGET /api/csrf-token [32m200[0m 1.009 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/administrator/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:39.931Z"}
[0mPOST /api/v1/auth/administrator/login [33m429[0m 0.898 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:40.406Z"}
[0mGET /api/csrf-token [32m200[0m 0.987 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/administrator/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:40.654Z"}
[0mPOST /api/v1/auth/administrator/login [33m429[0m 0.900 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:41.126Z"}
[0mGET /api/csrf-token [32m200[0m 1.650 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/administrator/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:41.397Z"}
[0mPOST /api/v1/auth/administrator/login [33m429[0m 0.793 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:41.874Z"}
[0mGET /api/csrf-token [32m200[0m 0.991 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:42.508Z"}
[0mGET /api/csrf-token [32m200[0m 0.886 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:43.154Z"}
[0mGET /api/csrf-token [32m200[0m 1.115 ms - 52[0m
FAIL tests/integration/auth.test.js (15.743 s)
  Authentication Integration Tests
    POST /api/v1/auth/affiliate/login
      ✓ should login affiliate with valid credentials (1198 ms)
      ✓ should fail with invalid credentials (822 ms)
      ✓ should fail with non-existent username (667 ms)
    POST /api/v1/auth/customer/login
      ✓ should login customer with valid credentials (978 ms)
    GET /api/v1/auth/verify
      ✓ should verify valid token (894 ms)
      ✓ should fail with invalid token (638 ms)
      ✓ should fail with missing token (659 ms)
    POST /api/v1/auth/refresh-token
      ✓ should refresh token successfully (1040 ms)
      ✓ should fail with invalid refresh token (637 ms)
      ✓ should fail with expired refresh token (801 ms)
    POST /api/v1/auth/logout
      ○ skipped should logout successfully and blacklist tokens
    Rate limiting tests
      ✕ should rate limit login attempts (1978 ms)
      ○ skipped should rate limit refresh token requests
    Concurrent refresh token usage
      ○ skipped should handle concurrent refresh token requests safely
    Token blacklisting after logout
      ○ skipped should blacklist all active tokens on logout
    POST /api/v1/auth/administrator/login
      ✕ should login administrator with valid credentials (740 ms)
      ✕ should fail with invalid administrator credentials (720 ms)
      ✕ should fail when administrator is inactive (748 ms)
    POST /api/v1/auth/operator/login
      ✕ should login operator with valid credentials (632 ms)
      ✕ should fail with invalid operator credentials (643 ms)
      ✕ should fail when operator is inactive (629 ms)

  ● Authentication Integration Tests › Rate limiting tests › should rate limit login attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 429

      475 |       // First 20 attempts should fail with invalid credentials
      476 |       for (let i = 0; i < 20; i++) {
    > 477 |         expect(responses[i].status).toBe(401);
          |                                     ^
      478 |       }
      479 |
      480 |       // 21st attempt should be rate limited

      at Object.toBe (tests/integration/auth.test.js:477:37)

  ● Authentication Integration Tests › POST /api/v1/auth/administrator/login › should login administrator with valid credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 429

      683 |         });
      684 |
    > 685 |       expect(response.status).toBe(200);
          |                               ^
      686 |       expect(response.body).toMatchObject({
      687 |         success: true,
      688 |         token: expect.any(String),

      at Object.toBe (tests/integration/auth.test.js:685:31)

  ● Authentication Integration Tests › POST /api/v1/auth/administrator/login › should fail with invalid administrator credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 429

      717 |         });
      718 |
    > 719 |       expect(response.status).toBe(401);
          |                               ^
      720 |       expect(response.body).toMatchObject({
      721 |         success: false,
      722 |         message: 'Invalid credentials'

      at Object.toBe (tests/integration/auth.test.js:719:31)

  ● Authentication Integration Tests › POST /api/v1/auth/administrator/login › should fail when administrator is inactive

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 429

      744 |         });
      745 |
    > 746 |       expect(response.status).toBe(403);
          |                               ^
      747 |       expect(response.body).toMatchObject({
      748 |         success: false,
      749 |         message: 'Account is inactive'

      at Object.toBe (tests/integration/auth.test.js:746:31)

  ● Authentication Integration Tests › POST /api/v1/auth/operator/login › should login operator with valid credentials

    ValidationError: Operator validation failed: createdBy: Path `createdBy` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Authentication Integration Tests › POST /api/v1/auth/operator/login › should fail with invalid operator credentials

    ValidationError: Operator validation failed: createdBy: Path `createdBy` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  ● Authentication Integration Tests › POST /api/v1/auth/operator/login › should fail when operator is inactive

    ValidationError: Operator validation failed: createdBy: Path `createdBy` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:44.882Z"}
[0mGET /api/csrf-token [32m200[0m 2.006 ms - 52[0m
[34mdebug[39m: POST /api/v1/affiliates/register {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:45.169Z"}
[0mPOST /api/v1/affiliates/register [32m201[0m 387.458 ms - 89[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:46.091Z"}
[0mGET /api/csrf-token [32m200[0m 1.876 ms - 52[0m
[34mdebug[39m: GET /api/v1/affiliates/AFF843724 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:46.154Z"}
[0mGET /api/v1/affiliates/AFF843724 [32m200[0m 29.683 ms - 355[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:46.669Z"}
[0mGET /api/csrf-token [32m200[0m 1.197 ms - 52[0m
[34mdebug[39m: PUT /api/v1/affiliates/AFF654726 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:46.736Z"}
  console.error
    === API ERROR ===

      12 |
      13 |   // Console log for immediate debugging
    > 14 |   console.error('=== API ERROR ===');
         |           ^
      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);

      at error (server/middleware/errorHandler.js:14:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error message: invalid csrf token

      13 |   // Console log for immediate debugging
      14 |   console.error('=== API ERROR ===');
    > 15 |   console.error('Error message:', err.message);
         |           ^
      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);

      at error (server/middleware/errorHandler.js:15:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error stack: ForbiddenError: invalid csrf token
        at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)
        at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)
        at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)
        at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9
        at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)
        at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5

      14 |   console.error('=== API ERROR ===');
      15 |   console.error('Error message:', err.message);
    > 16 |   console.error('Error stack:', err.stack);
         |           ^
      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);

      at error (server/middleware/errorHandler.js:16:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request path: /api/v1/affiliates/AFF654726

      15 |   console.error('Error message:', err.message);
      16 |   console.error('Error stack:', err.stack);
    > 17 |   console.error('Request path:', req.path);
         |           ^
      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);

      at error (server/middleware/errorHandler.js:17:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Request method: PUT

      16 |   console.error('Error stack:', err.stack);
      17 |   console.error('Request path:', req.path);
    > 18 |   console.error('Request method:', req.method);
         |           ^
      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');

      at error (server/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error type: ForbiddenError

      17 |   console.error('Request path:', req.path);
      18 |   console.error('Request method:', req.method);
    > 19 |   console.error('Error type:', err.name);
         |           ^
      20 |   console.error('Error code:', err.code);
      21 |   console.error('================');
      22 |

      at error (server/middleware/errorHandler.js:19:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    Error code: EBADCSRFTOKEN

      18 |   console.error('Request method:', req.method);
      19 |   console.error('Error type:', err.name);
    > 20 |   console.error('Error code:', err.code);
         |           ^
      21 |   console.error('================');
      22 |
      23 |   // Log the error with additional context

      at error (server/middleware/errorHandler.js:20:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

  console.error
    ================

      19 |   console.error('Error type:', err.name);
      20 |   console.error('Error code:', err.code);
    > 21 |   console.error('================');
         |           ^
      22 |
      23 |   // Log the error with additional context
      24 |   try {

      at error (server/middleware/errorHandler.js:21:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrf (node_modules/csurf/index.js:112:14)
      at csrfProtection (server.js:269:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at serveStatic (node_modules/serve-static/index.js:75:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at session (node_modules/express-session/index.js:487:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:695:7
      at node_modules/express-rate-limit/dist/index.cjs:611:5

[31merror[39m: API Error: {"error":"invalid csrf token","errorCode":"EBADCSRFTOKEN","errorType":"ForbiddenError","ip":"::ffff:127.0.0.1","method":"PUT","path":"/api/v1/affiliates/AFF654726","service":"wavemax-affiliate","stack":"ForbiddenError: invalid csrf token\n    at csrf (/var/www/wavemax/wavemax-affiliate-program/node_modules/csurf/index.js:112:19)\n    at csrfProtection (/var/www/wavemax/wavemax-affiliate-program/server.js:269:3)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at serveStatic (/var/www/wavemax/wavemax-affiliate-program/node_modules/serve-static/index.js:75:16)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at session (/var/www/wavemax/wavemax-affiliate-program/node_modules/express-session/index.js:487:7)\n    at Layer.handle [as handle_request] (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:328:13)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:346:12)\n    at next (/var/www/wavemax/wavemax-affiliate-program/node_modules/express/lib/router/index.js:280:10)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:695:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at /var/www/wavemax/wavemax-affiliate-program/node_modules/express-rate-limit/dist/index.cjs:611:5","timestamp":"2025-05-28T14:44:46.801Z","userId":null}
[0mPUT /api/v1/affiliates/AFF654726 [33m403[0m 65.759 ms - -[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:47.303Z"}
[0mGET /api/csrf-token [32m200[0m 1.089 ms - 52[0m
[34mdebug[39m: POST /api/v1/auth/affiliate/login {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:47.463Z"}
info: undefined {"eventType":"LOGIN_SUCCESS","ip":"::ffff:127.0.0.1","method":"POST","path":"/affiliate/login","reason":null,"success":true,"timestamp":"2025-05-28T14:44:47.615Z","userType":"affiliate","username":"testaffiliate"}
[0mPOST /api/v1/auth/affiliate/login [32m200[0m 152.565 ms - 522[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:48.100Z"}
[0mGET /api/csrf-token [32m200[0m 0.866 ms - 52[0m
[34mdebug[39m: GET /api/v1/affiliates/AFF829351/customers?page=1&limit=10 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:48.216Z"}
[0mGET /api/v1/affiliates/AFF829351/customers?page=1&limit=10 [32m200[0m 85.316 ms - 602[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:48.790Z"}
[0mGET /api/csrf-token [32m200[0m 0.939 ms - 52[0m
[34mdebug[39m: GET /api/v1/affiliates/AFF968740/orders?page=1&limit=10 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:48.889Z"}
[0mGET /api/v1/affiliates/AFF968740/orders?page=1&limit=10 [32m200[0m 81.919 ms - 741[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:49.449Z"}
[0mGET /api/csrf-token [32m200[0m 0.750 ms - 52[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:49.977Z"}
[0mGET /api/csrf-token [32m200[0m 0.894 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/affiliates/AFF750598/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:50.137Z"}
  console.log
    Delete data request received

      at log (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at log (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: { affiliateId: 'AFF750598' }

      at log (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: {
      id: '68372162c493d3dd8ce1b485',
      role: 'affiliate',
      affiliateId: 'AFF750598'
    }

      at log (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: {
      host: '127.0.0.1:38991',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcyMTYyYzQ5M2QzZGQ4Y2UxYjQ4NSIsImFmZmlsaWF0ZUlkIjoiQUZGNzUwNTk4Iiwicm9sZSI6ImFmZmlsaWF0ZSIsImlhdCI6MTc0ODQ0MzQ5MCwiZXhwIjoxNzQ4NDQ3MDkwfQ.2xD-wsGM7giB2g2VzaZSRCZEE_G2UN4t7Gfo_KAF7aw',
      'x-csrf-token': 'q2mKuD34-ZVvcRd2AifQX5JyUVWpLGzC8eFg',
      connection: 'close'
    }

      at log (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:44:50.137Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at log (server/controllers/affiliateController.js:830:13)

[0mDELETE /api/v1/affiliates/AFF750598/delete-all-data [32m200[0m 233.235 ms - 225[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:50.944Z"}
[0mGET /api/csrf-token [32m200[0m 1.206 ms - 52[0m
[34mdebug[39m: DELETE /api/v1/affiliates/AFF226969/delete-all-data {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:44:51.008Z"}
  console.log
    Delete data request received

      at log (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: production

      at log (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: { affiliateId: 'AFF226969' }

      at log (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: {
      id: '68372162c493d3dd8ce1b4aa',
      role: 'affiliate',
      affiliateId: 'AFF226969'
    }

      at log (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: {
      host: '127.0.0.1:42557',
      'accept-encoding': 'gzip, deflate',
      authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MzcyMTYyYzQ5M2QzZGQ4Y2UxYjRhYSIsImFmZmlsaWF0ZUlkIjoiQUZGMjI2OTY5Iiwicm9sZSI6ImFmZmlsaWF0ZSIsImlhdCI6MTc0ODQ0MzQ5MSwiZXhwIjoxNzQ4NDQ3MDkxfQ.IXDTDNe9oL6kPiIH-kWaBVlwCweavsQ2Uk3HGg-5k04',
      'x-csrf-token': 'eAWtXjka-tHH5U6H2IHqHb_JamTBxPBMdvEg',
      connection: 'close'
    }

      at log (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: Session {
      cookie: {
        path: '/',
        _expires: 2025-05-29T14:44:51.009Z,
        originalMaxAge: 86400000,
        httpOnly: true,
        secure: true,
        sameSite: 'lax'
      }
    }

      at log (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at log (server/controllers/affiliateController.js:830:13)

  console.log
    Environment check failed

      at log (server/controllers/affiliateController.js:834:15)

[0mDELETE /api/v1/affiliates/AFF226969/delete-all-data [33m403[0m 20.712 ms - 73[0m
FAIL tests/integration/affiliate.test.js (7.736 s)
  Affiliate API
    ✓ should register a new affiliate (1235 ms)
    ✓ should get affiliate profile (578 ms)
    ✕ should update affiliate profile (633 ms)
    ✓ should login affiliate (791 ms)
    ✕ should get affiliate's customers list (696 ms)
    ✕ should get affiliate's orders (658 ms)
    ✕ should get affiliate's earnings/transactions (526 ms)
    ✓ Delete all affiliate data (development only) (965 ms)
    ✓ Reject delete in production environment (595 ms)
    ○ skipped should update payment information
    ○ skipped should handle commission-related endpoints

  ● Affiliate API › should update affiliate profile

    expect(received).toEqual(expected) // deep equality

    Expected: 200
    Received: 403

       98 |       });
       99 |
    > 100 |     expect(res.statusCode).toEqual(200);
          |                            ^
      101 |     expect(res.body).toHaveProperty('success', true);
      102 |
      103 |     // Verify the update

      at Object.toEqual (tests/integration/affiliate.test.js:100:28)

  ● Affiliate API › should get affiliate's customers list

    expect(received).toMatchObject(expected)

    - Expected  - 2
    + Received  + 0

      Object {
    -   "currentPage": 1,
        "pages": 1,
    -   "perPage": 10,
        "total": 2,
      }

      177 |     expect(res.body.customers).toHaveLength(2);
      178 |     expect(res.body).toHaveProperty('pagination');
    > 179 |     expect(res.body.pagination).toMatchObject({
          |                                 ^
      180 |       total: 2,
      181 |       pages: 1,
      182 |       currentPage: 1,

      at Object.toMatchObject (tests/integration/affiliate.test.js:179:33)

  ● Affiliate API › should get affiliate's orders

    expect(received).toHaveProperty(path, value)

    Expected path: "totalEarnings"
    Received path: []

    Expected value: 44.41
    Received value: {"orders": [{"actualTotal": 50.41, "actualWeight": 23.5, "createdAt": "2025-05-28T14:44:48.856Z", "customer": null, "customerId": "CUST001", "deliveryDate": "2025-05-27T00:00:00.000Z", "deliveryTime": "afternoon", "estimatedSize": "medium", "estimatedTotal": 49.46, "orderId": "ORD001", "pickupDate": "2025-05-25T00:00:00.000Z", "pickupTime": "morning", "status": "delivered"}, {"createdAt": "2025-05-28T14:44:48.856Z", "customer": null, "customerId": "CUST002", "deliveryDate": "2025-05-28T00:00:00.000Z", "deliveryTime": "morning", "estimatedSize": "large", "estimatedTotal": 72.14, "orderId": "ORD002", "pickupDate": "2025-05-26T00:00:00.000Z", "pickupTime": "afternoon", "status": "processing"}], "pagination": {"limit": "10", "page": "1", "pages": 1, "total": 2}, "success": true, "totalItems": 2}

      229 |     expect(res.body.orders).toHaveLength(2);
      230 |     expect(res.body).toHaveProperty('pagination');
    > 231 |     expect(res.body).toHaveProperty('totalEarnings', 44.41);
          |                      ^
      232 |   });
      233 |
      234 |   test('should get affiliate\'s earnings/transactions', async () => {

      at Object.toHaveProperty (tests/integration/affiliate.test.js:231:22)

  ● Affiliate API › should get affiliate's earnings/transactions

    ValidationError: Transaction validation failed: payoutMethod: Path `payoutMethod` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3343:32)
      at node_modules/mongoose/lib/document.js:3104:17
      at node_modules/mongoose/lib/schemaType.js:1407:9

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

FAIL tests/unit/models.test.js (6.885 s)
  Model Tests
    Affiliate Model
      ✓ should create a valid affiliate (560 ms)
      ✓ should require required fields (315 ms)
      ✕ should enforce unique constraints (382 ms)
      ○ skipped should handle payment information correctly
    Customer Model
      ✕ should create a valid customer (342 ms)
      ✕ should validate service frequency (312 ms)
    Order Model
      ✓ should create a valid order (347 ms)
      ✓ should calculate estimated total correctly (343 ms)
      ✓ should calculate actual total and commission when weight is set (345 ms)
      ✓ should update timestamps for status changes (472 ms)
    Bag Model
      ✓ should create a valid bag (338 ms)
      ✓ should generate unique barcodes (375 ms)
    Transaction Model
      ✓ should create a valid transaction (345 ms)
      ✓ should validate transaction type (307 ms)
      ✓ should validate transaction status (305 ms)
    RefreshToken Model
      ✓ should create a valid refresh token (342 ms)
      ✓ should validate user type (307 ms)
      ✓ should check if token is expired (374 ms)

  ● Model Tests › Affiliate Model › should enforce unique constraints

    expect(received).toBeDefined()

    Received: undefined

      90 |       }
      91 |
    > 92 |       expect(error).toBeDefined();
         |                     ^
      93 |       expect(error.code).toBe(11000); // MongoDB duplicate key error
      94 |     });
      95 |

      at Object.toBeDefined (tests/unit/models.test.js:92:21)

  ● Model Tests › Customer Model › should create a valid customer

    expect(received).toBe(expected) // Object.is equality

    Expected: "weekly"
    Received: undefined

      145 |       expect(saved.email).toBe('jane@example.com');
      146 |       expect(saved.isActive).toBe(true); // Default value
    > 147 |       expect(saved.serviceFrequency).toBe('weekly');
          |                                      ^
      148 |     });
      149 |
      150 |     it('should validate service frequency', async () => {

      at Object.toBe (tests/unit/models.test.js:147:38)

  ● Model Tests › Customer Model › should validate service frequency

    expect(received).toBeDefined()

    Received: undefined

      172 |
      173 |       expect(error).toBeDefined();
    > 174 |       expect(error.errors.serviceFrequency).toBeDefined();
          |                                             ^
      175 |     });
      176 |   });
      177 |

      at Object.toBeDefined (tests/unit/models.test.js:174:45)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

  console.error
    Error creating operator: TypeError: auditLogger.log is not a function
        at log (/var/www/wavemax/wavemax-affiliate-program/server/controllers/administratorController.js:61:23)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/administratorController.test.js:79:9)

      75 |
      76 |   } catch (error) {
    > 77 |     console.error('Error creating operator:', error);
         |             ^
      78 |     res.status(500).json({
      79 |       success: false,
      80 |       message: 'Failed to create operator'

      at error (server/controllers/administratorController.js:77:13)
      at Object.<anonymous> (tests/unit/administratorController.test.js:79:9)

  console.error
    Error fetching operators: TypeError: Operator.find(...).sort(...).limit is not a function
        at limit (/var/www/wavemax/wavemax-affiliate-program/server/controllers/administratorController.js:123:8)
        at Object.getOperators (/var/www/wavemax/wavemax-affiliate-program/tests/unit/administratorController.test.js:113:15)
        at Promise.then.completed (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:252:3)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at run (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:444:34)

      139 |
      140 |   } catch (error) {
    > 141 |     console.error('Error fetching operators:', error);
          |             ^
      142 |     res.status(500).json({
      143 |       success: false,
      144 |       message: 'Failed to fetch operators'

      at error (server/controllers/administratorController.js:141:13)
      at Object.getOperators (tests/unit/administratorController.test.js:113:15)

  console.error
    Error fetching dashboard data: TypeError: Cannot read properties of undefined (reading 'then')
        at Object.<anonymous>.exports.getDashboard (/var/www/wavemax/wavemax-affiliate-program/server/controllers/administratorController.js:505:53)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/administratorController.test.js:172:9)

      531 |
      532 |   } catch (error) {
    > 533 |     console.error('Error fetching dashboard data:', error);
          |             ^
      534 |     res.status(500).json({
      535 |       success: false,
      536 |       message: 'Failed to fetch dashboard data'

      at error (server/controllers/administratorController.js:533:13)
      at Object.<anonymous> (tests/unit/administratorController.test.js:172:9)

  console.error
    Error updating system config: TypeError: Cannot read properties of undefined (reading 'value')
        at value (/var/www/wavemax/wavemax-affiliate-program/server/controllers/administratorController.js:973:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/administratorController.test.js:243:9)

      981 |
      982 |   } catch (error) {
    > 983 |     console.error('Error updating system config:', error);
          |             ^
      984 |     res.status(500).json({
      985 |       success: false,
      986 |       message: error.message || 'Failed to update system configuration'

      at error (server/controllers/administratorController.js:983:13)
      at Object.<anonymous> (tests/unit/administratorController.test.js:243:9)

  console.error
    Error updating system config: TypeError: Cannot read properties of undefined (reading 'value')
        at value (/var/www/wavemax/wavemax-affiliate-program/server/controllers/administratorController.js:973:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/administratorController.test.js:260:9)

      981 |
      982 |   } catch (error) {
    > 983 |     console.error('Error updating system config:', error);
          |             ^
      984 |     res.status(500).json({
      985 |       success: false,
      986 |       message: error.message || 'Failed to update system configuration'

      at error (server/controllers/administratorController.js:983:13)
      at Object.<anonymous> (tests/unit/administratorController.test.js:260:9)

FAIL tests/unit/administratorController.test.js
  Administrator Controller
    Operator Management
      createOperator
        ✕ should create a new operator (137 ms)
      getOperators
        ✕ should return list of operators with pagination (62 ms)
      updateOperator
        ✕ should update operator details (54 ms)
    Analytics
      getDashboard
        ✕ should return dashboard analytics (59 ms)
      getOrderAnalytics
        ✕ should return order analytics (54 ms)
    System Configuration
      getSystemConfig
        ✕ should return all system configurations (60 ms)
      updateSystemConfig
        ✕ should update system configuration (55 ms)
        ✕ should return 404 if configuration not found (58 ms)
    System Health
      getSystemHealth
        ✕ should return system health status (55 ms)

  ● Administrator Controller › Operator Management › createOperator › should create a new operator

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "operator_created", Any<Object>

    Number of calls: 0

      82 |         expect(mockSave).toHaveBeenCalled();
      83 |         expect(emailService.sendOperatorWelcomeEmail).toHaveBeenCalled();
    > 84 |         expect(auditLogger.log).toHaveBeenCalledWith('operator_created', expect.any(Object));
         |                                 ^
      85 |         expect(res.status).toHaveBeenCalledWith(201);
      86 |         expect(res.json).toHaveBeenCalledWith(expect.objectContaining({
      87 |           success: true,

      at Object.toHaveBeenCalledWith (tests/unit/administratorController.test.js:84:33)

  ● Administrator Controller › Operator Management › getOperators › should return list of operators with pagination

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "operators": Array [
    -     Object {
    -       "_id": "1",
    -       "email": "op1@example.com",
    -       "operatorId": "OPR001",
    -     },
    -     Object {
    -       "_id": "2",
    -       "email": "op2@example.com",
    -       "operatorId": "OPR002",
    -     },
    -   ],
    -   "page": 1,
    -   "pages": 1,
    -   "success": true,
    -   "total": 2,
    +   "message": "Failed to fetch operators",
    +   "success": false,
      },

    Number of calls: 1

      114 |
      115 |         expect(Operator.find).toHaveBeenCalled();
    > 116 |         expect(res.json).toHaveBeenCalledWith({
          |                          ^
      117 |           success: true,
      118 |           operators: mockOperators,
      119 |           total: 2,

      at Object.toHaveBeenCalledWith (tests/unit/administratorController.test.js:116:26)

  ● Administrator Controller › Operator Management › updateOperator › should update operator details

    expect(received).toBe(expected) // Object.is equality

    Expected: "Jane"
    Received: "John"

      143 |         await updateOperator(req, res);
      144 |
    > 145 |         expect(mockOperator.firstName).toBe('Jane');
          |                                        ^
      146 |         expect(mockOperator.lastName).toBe('Smith');
      147 |         expect(mockOperator.save).toHaveBeenCalled();
      148 |         expect(auditLogger.log).toHaveBeenCalledWith('operator_updated', expect.any(Object));

      at Object.toBe (tests/unit/administratorController.test.js:145:40)

  ● Administrator Controller › Analytics › getDashboard › should return dashboard analytics

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"data": ObjectContaining {"activeOperators": Any<Number>, "ordersToday": Any<Number>}, "success": true}
    Received: {"message": "Failed to fetch dashboard data", "success": false}

    Number of calls: 1

      172 |         await getDashboard(req, res);
      173 |
    > 174 |         expect(res.json).toHaveBeenCalledWith(expect.objectContaining({
          |                          ^
      175 |           success: true,
      176 |           data: expect.objectContaining({
      177 |             ordersToday: expect.any(Number),

      at Object.toHaveBeenCalledWith (tests/unit/administratorController.test.js:174:26)

  ● Administrator Controller › Analytics › getOrderAnalytics › should return order analytics

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "data": Any<Object>,
    +   "analytics": Object {
    +     "processingTimeDistribution": Array [
    +       Object {
    +         "_id": "2024-01-01",
    +         "count": 10,
    +         "revenue": 500,
    +       },
    +       Object {
    +         "_id": "2024-01-02",
    +         "count": 15,
    +         "revenue": 750,
    +       },
    +     ],
    +     "summary": Object {
    +       "averageOrderValue": 0,
    +       "averageProcessingTime": 0,
    +       "totalOrders": NaN,
    +       "totalRevenue": 0,
    +     },
    +     "timeline": Array [
    +       Object {
    +         "_id": "2024-01-01",
    +         "count": 10,
    +         "revenue": 500,
    +       },
    +       Object {
    +         "_id": "2024-01-02",
    +         "count": 15,
    +         "revenue": 750,
    +       },
    +     ],
    +   },
        "success": true,
      },

    Number of calls: 1

      196 |
      197 |         expect(Order.aggregate).toHaveBeenCalled();
    > 198 |         expect(res.json).toHaveBeenCalledWith({
          |                          ^
      199 |           success: true,
      200 |           data: expect.any(Object)
      201 |         });

      at Object.toHaveBeenCalledWith (tests/unit/administratorController.test.js:198:26)

  ● Administrator Controller › System Configuration › getSystemConfig › should return all system configurations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

    @@ -1,7 +1,7 @@
      Object {
    -   "configs": Array [
    +   "configurations": Array [
          Object {
            "key": "order_processing_hours",
            "value": Object {
              "end": "22:00",
              "start": "06:00",,

    Number of calls: 1

      219 |
      220 |         expect(SystemConfig.find).toHaveBeenCalled();
    > 221 |         expect(res.json).toHaveBeenCalledWith({
          |                          ^
      222 |           success: true,
      223 |           configs: mockConfigs
      224 |         });

      at Object.toHaveBeenCalledWith (tests/unit/administratorController.test.js:221:26)

  ● Administrator Controller › System Configuration › updateSystemConfig › should update system configuration

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "end": "23:00",
    -   "start": "07:00",
    +   "end": "22:00",
    +   "start": "06:00",
      }

      243 |         await updateSystemConfig(req, res);
      244 |
    > 245 |         expect(mockConfig.value).toEqual(req.body.value);
          |                                  ^
      246 |         expect(mockConfig.lastModifiedBy).toBe(req.user._id);
      247 |         expect(mockConfig.save).toHaveBeenCalled();
      248 |         expect(auditLogger.log).toHaveBeenCalledWith('system_config_updated', expect.any(Object));

      at Object.toEqual (tests/unit/administratorController.test.js:245:34)

  ● Administrator Controller › System Configuration › updateSystemConfig › should return 404 if configuration not found

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 404
    Received: 500

    Number of calls: 1

      260 |         await updateSystemConfig(req, res);
      261 |
    > 262 |         expect(res.status).toHaveBeenCalledWith(404);
          |                            ^
      263 |         expect(res.json).toHaveBeenCalledWith({
      264 |           success: false,
      265 |           message: 'Configuration not found'

      at Object.toHaveBeenCalledWith (tests/unit/administratorController.test.js:262:28)

  ● Administrator Controller › System Health › getSystemHealth › should return system health status

    ReferenceError: mongoose is not defined

      275 |         
      276 |         // Mock mongoose connection
    > 277 |         mongoose.connection = {
          |         ^
      278 |           readyState: 1,
      279 |           db: {
      280 |             admin: jest.fn().mockReturnValue({

      at Object.mongoose (tests/unit/administratorController.test.js:277:9)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

FAIL tests/unit/operatorController.test.js
  Operator Controller
    getDashboard
      ✓ should return operator dashboard data (4 ms)
    getOrderQueue
      ✕ should return available orders for operator workstation (2 ms)
    claimOrder
      ✕ should allow operator to claim an order (1 ms)
      ✕ should fail if order is already claimed
    updateOrderStatus
      ✓ should update order status (1 ms)
    performQualityCheck
      ✕ should record quality check results (1 ms)
    getMyOrders
      ✕ should return orders assigned to operator
    updateShiftStatus
      ✕ should update operator shift status
    getPerformanceStats
      ✕ should return operator performance statistics (1 ms)
    getCustomerDetails
      ✕ should return customer details for an order
    addCustomerNote
      ✕ should add a note to an order (1 ms)

  ● Operator Controller › getOrderQueue › should return available orders for operator workstation

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
        "orderProcessingStatus": "pending",
    -   "scheduledPickup": Object {
    -     "$lte": Any<Date>,
    -   },
      },

    Number of calls: 1

      128 |       await getOrderQueue(req, res);
      129 |
    > 130 |       expect(Order.find).toHaveBeenCalledWith({
          |                          ^
      131 |         orderProcessingStatus: 'pending',
      132 |         scheduledPickup: { $lte: expect.any(Date) }
      133 |       });

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:130:26)

  ● Operator Controller › claimOrder › should allow operator to claim an order

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Order claimed successfully",
    -   "order": Object {
    -     "_id": "order123",
    -     "assignedOperator": "op123",
    -     "orderNumber": "ORD001",
    -     "orderProcessingStatus": "assigned",
    -     "processingStarted": 2025-05-28T14:45:03.545Z,
    -     "save": [Function mockConstructor],
    -   },
    +   "error": "Failed to claim order",
      },

    Number of calls: 1

      159 |       expect(mockOrder.processingStarted).toBeDefined();
      160 |       expect(mockOrder.save).toHaveBeenCalled();
    > 161 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      162 |         message: 'Order claimed successfully',
      163 |         order: mockOrder
      164 |       });

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:161:24)

  ● Operator Controller › claimOrder › should fail if order is already claimed

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "error": "Order is already assigned to another operator",
    +   "error": "Order already assigned",
      },

    Number of calls: 1

      180 |
      181 |       expect(res.status).toHaveBeenCalledWith(400);
    > 182 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      183 |         error: 'Order is already assigned to another operator'
      184 |       });
      185 |     });

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:182:24)

  ● Operator Controller › performQualityCheck › should record quality check results

    expect(received).toMatchObject(expected)

    - Expected  - 6
    + Received  + 1

    - Object {
    -   "notes": "All items clean and properly folded",
    -   "passed": true,
    -   "performedAt": Any<Date>,
    -   "performedBy": "op123",
    - }
    + Object {}

      242 |       await performQualityCheck(req, res);
      243 |
    > 244 |       expect(mockOrder.qualityCheck).toMatchObject({
          |                                      ^
      245 |         passed: true,
      246 |         performedBy: 'op123',
      247 |         performedAt: expect.any(Date),

      at Object.toMatchObject (tests/unit/operatorController.test.js:244:38)

  ● Operator Controller › getMyOrders › should return orders assigned to operator

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "count": 2,
    -   "orders": Array [
    -     Object {
    -       "_id": "1",
    -       "orderNumber": "ORD001",
    -       "orderProcessingStatus": "processing",
    -     },
    -     Object {
    -       "_id": "2",
    -       "orderNumber": "ORD002",
    -       "orderProcessingStatus": "ready",
    -     },
    -   ],
    -   "success": true,
    +   "error": "Failed to fetch orders",
      },

    Number of calls: 1

      272 |
      273 |       expect(Order.find).toHaveBeenCalledWith({ assignedOperator: 'op123' });
    > 274 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      275 |         success: true,
      276 |         orders: mockOrders,
      277 |         count: 2

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:274:24)

  ● Operator Controller › updateShiftStatus › should update operator shift status

    expect(received).toBe(expected) // Object.is equality

    Expected: "active"
    Received: "inactive"

      295 |       await updateShiftStatus(req, res);
      296 |
    > 297 |       expect(mockOperator.shiftStatus).toBe('active');
          |                                        ^
      298 |       expect(mockOperator.lastStatusUpdate).toBeDefined();
      299 |       expect(mockOperator.save).toHaveBeenCalled();
      300 |       expect(auditLogger.log).toHaveBeenCalledWith('operator', 'op123', 'shift.status_updated', expect.any(Object));

      at Object.toBe (tests/unit/operatorController.test.js:297:40)

  ● Operator Controller › getPerformanceStats › should return operator performance statistics

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      323 |       await getPerformanceStats(req, res);
      324 |
    > 325 |       expect(Order.aggregate).toHaveBeenCalled();
          |                               ^
      326 |       expect(res.json).toHaveBeenCalledWith({
      327 |         stats: {
      328 |           totalOrders: 50,

      at Object.toHaveBeenCalled (tests/unit/operatorController.test.js:325:31)

  ● Operator Controller › getCustomerDetails › should return customer details for an order

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "order123"

    Number of calls: 0

      359 |       await getCustomerDetails(req, res);
      360 |
    > 361 |       expect(Order.findById).toHaveBeenCalledWith('order123');
          |                              ^
      362 |       expect(res.json).toHaveBeenCalledWith({
      363 |         customer: mockOrder.customer,
      364 |         orderDetails: {

      at Object.toHaveBeenCalledWith (tests/unit/operatorController.test.js:361:30)

  ● Operator Controller › addCustomerNote › should add a note to an order

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      391 |       await addCustomerNote(req, res);
      392 |
    > 393 |       expect(mockOrder.customerNotes).toHaveLength(1);
          |                                       ^
      394 |       expect(mockOrder.customerNotes[0]).toMatchObject({
      395 |         note: 'Customer requested extra starch',
      396 |         addedBy: 'op123',

      at Object.toHaveLength (tests/unit/operatorController.test.js:393:39)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

  console.warn
    Welcome email could not be sent: Error: Email failed
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:161:64)
        at Promise.then.completed (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:252:3)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at run (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:444:34)

      93 |       // Email sent successfully - no need to check result
      94 |     } catch (emailError) {
    > 95 |       console.warn('Welcome email could not be sent:', emailError);
         |               ^
      96 |       // Continue with registration process even if email fails
      97 |     }
      98 |

      at Object.warn [as registerAffiliate] (server/controllers/affiliateController.js:95:15)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:163:7)

  console.error
    Affiliate registration error: Error: Database error
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:178:43)
        at Promise.then.completed (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:252:3)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at run (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:444:34)

      103 |     });
      104 |   } catch (error) {
    > 105 |     console.error('Affiliate registration error:', error);
          |             ^
      106 |     res.status(500).json({
      107 |       success: false,
      108 |       message: 'An error occurred during registration'

      at Object.error [as registerAffiliate] (server/controllers/affiliateController.js:105:13)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:180:7)

  console.error
    Error decrypting PayPal email: Error: Decryption failed
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:275:15)
        at /var/www/wavemax/wavemax-affiliate-program/node_modules/jest-mock/build/index.js:397:39
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-mock/build/index.js:404:13)
        at Object.mockConstructor [as decrypt] (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-mock/build/index.js:148:19)
        at Object.decrypt [as getAffiliateProfile] (/var/www/wavemax/wavemax-affiliate-program/server/controllers/affiliateController.js:163:28)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:278:7)

      164 |           : affiliate.paypalEmail;
      165 |       } catch (error) {
    > 166 |         console.error('Error decrypting PayPal email:', error);
          |                 ^
      167 |         // Don't include if decryption fails
      168 |       }
      169 |     }

      at Object.error [as getAffiliateProfile] (server/controllers/affiliateController.js:166:17)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:278:7)

  console.error
    Get affiliate orders error: TypeError: Cannot read properties of undefined (reading 'forEach')
        at Object.forEach [as getAffiliateOrders] (/var/www/wavemax/wavemax-affiliate-program/server/controllers/affiliateController.js:580:15)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:684:7)

      619 |     });
      620 |   } catch (error) {
    > 621 |     console.error('Get affiliate orders error:', error);
          |             ^
      622 |     res.status(500).json({
      623 |       success: false,
      624 |       message: 'An error occurred while retrieving orders'

      at Object.error [as getAffiliateOrders] (server/controllers/affiliateController.js:621:13)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:684:7)

  console.error
    Get affiliate profile error: Error: Database connection lost
        at Object.<anonymous> (/var/www/wavemax/wavemax-affiliate-program/tests/unit/affiliateController.test.js:876:43)
        at Promise.then.completed (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:252:3)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:121:9)
        at run (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/var/www/wavemax/wavemax-affiliate-program/node_modules/jest-runner/build/runTest.js:444:34)

      175 |     });
      176 |   } catch (error) {
    > 177 |     console.error('Get affiliate profile error:', error);
          |             ^
      178 |     res.status(500).json({
      179 |       success: false,
      180 |       message: 'An error occurred while retrieving affiliate profile'

      at Object.error [as getAffiliateProfile] (server/controllers/affiliateController.js:177:13)
      at Object.<anonymous> (tests/unit/affiliateController.test.js:878:7)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF123' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: production

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF123' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

  console.log
    Environment check failed

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:834:15)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF456' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

  console.log
    Delete data request received

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:824:13)

  console.log
    NODE_ENV: development

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:825:13)

  console.log
    req.params: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:826:13)

  console.log
    req.user: { affiliateId: 'AFF123' }

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:827:13)

  console.log
    req.headers: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:828:13)

  console.log
    req.session: undefined

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:829:13)

  console.log
    req.body: {}

      at Object.log [as deleteAffiliateData] (server/controllers/affiliateController.js:830:13)

FAIL tests/unit/affiliateController.test.js
  Affiliate Controller
    registerAffiliate
      ✓ should successfully register a new affiliate (2 ms)
      ✓ should return validation errors (1 ms)
      ✓ should handle duplicate email or username
      ✓ should handle email service failure gracefully (42 ms)
      ✓ should handle database errors (2 ms)
    getAffiliateProfile
      ✓ should return affiliate profile for authorized user (1 ms)
      ✓ should return 404 for non-existent affiliate
      ✓ should return 403 for unauthorized access (4 ms)
      ✓ should handle decryption errors gracefully (23 ms)
    updateAffiliateProfile
      ✓ should successfully update affiliate profile (14 ms)
      ✓ should handle password change (1 ms)
      ✓ should reject incorrect current password (1 ms)
      ✓ should update payment method (5 ms)
    getAffiliateEarnings
      ✓ should return earnings for specified period (2 ms)
      ✓ should handle different time periods (1 ms)
      ✓ should handle missing customers gracefully (1 ms)
    getAffiliateCustomers
      ✓ should return paginated customers with search (1 ms)
      ✓ should handle different sort options (1 ms)
    getAffiliateOrders
      ✓ should return filtered orders (1 ms)
      ✓ should handle date filters correctly (2 ms)
    getAffiliateTransactions
      ✓ should return paginated transactions (1 ms)
    getAffiliateDashboardStats
      ✓ should return comprehensive dashboard statistics (3 ms)
      ✓ should handle empty data gracefully
    getPublicAffiliateInfo
      ✓ should return only public affiliate information (3 ms)
      ✓ should return 404 for non-existent affiliate (1 ms)
    Error handling
      ✓ should handle database connection errors (1 ms)
    deleteAffiliateData
      ✕ should delete all affiliate data in development environment (9 ms)
      ✓ should reject deletion in production environment (11 ms)
      ✕ should reject unauthorized deletion (5 ms)
      ✕ should handle deletion errors (10 ms)

  ● Affiliate Controller › deleteAffiliateData › should delete all affiliate data in development environment

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"$or": [{"affiliateId": "AFF123"}, {"customerId": {"$in": ["CUST1", "CUST2"]}}]}

    Number of calls: 0

      909 |       await affiliateController.deleteAffiliateData(req, res);
      910 |
    > 911 |       expect(Order.deleteMany).toHaveBeenCalledWith({
          |                                ^
      912 |         $or: [
      913 |           { affiliateId: 'AFF123' },
      914 |           { customerId: { $in: ['CUST1', 'CUST2'] } }

      at Object.toHaveBeenCalledWith (tests/unit/affiliateController.test.js:911:32)

  ● Affiliate Controller › deleteAffiliateData › should reject unauthorized deletion

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Unauthorized",
    +   "message": "You can only delete your own data",
        "success": false,
      },

    Number of calls: 1

      960 |
      961 |       expect(res.status).toHaveBeenCalledWith(403);
    > 962 |       expect(res.json).toHaveBeenCalledWith({
          |                        ^
      963 |         success: false,
      964 |         message: 'Unauthorized'
      965 |       });

      at Object.toHaveBeenCalledWith (tests/unit/affiliateController.test.js:962:24)

  ● Affiliate Controller › deleteAffiliateData › should handle deletion errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 403

    Number of calls: 1

      973 |       await affiliateController.deleteAffiliateData(req, res);
      974 |
    > 975 |       expect(res.status).toHaveBeenCalledWith(500);
          |                          ^
      976 |       expect(res.json).toHaveBeenCalledWith({
      977 |         success: false,
      978 |         message: 'An error occurred while deleting data'

      at Object.toHaveBeenCalledWith (tests/unit/affiliateController.test.js:975:26)

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:07.117Z"}
[0mGET /api/csrf-token [32m200[0m 2.962 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:07.822Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST123',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      specialPickupInstructions: 'Ring doorbell',
      estimatedSize: 'medium',
      serviceNotes: 'Handle with care',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon',
      specialDeliveryInstructions: 'Leave at door'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST123

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Jane Smith

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: AFF123

      at log (server/controllers/orderController.js:62:13)

  console.log
    Found affiliate: John Doe

      at log (server/controllers/orderController.js:72:13)

[0mPOST /api/v1/orders [32m201[0m 131.790 ms - 104[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:08.492Z"}
[0mGET /api/csrf-token [32m200[0m 1.119 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:08.807Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST123',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'small',
      deliveryDate: '2025-05-27',
      deliveryTime: 'evening'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST123

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Jane Smith

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: AFF123

      at log (server/controllers/orderController.js:62:13)

  console.log
    Found affiliate: John Doe

      at log (server/controllers/orderController.js:72:13)

[0mPOST /api/v1/orders [32m201[0m 87.873 ms - 104[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:09.371Z"}
[0mGET /api/csrf-token [32m200[0m 0.929 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:09.669Z"}
  console.log
    Creating order with data: {
      customerId: 'INVALID',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'medium',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: INVALID

      at log (server/controllers/orderController.js:49:13)

  console.log
    Customer not found with ID: INVALID

      at log (server/controllers/orderController.js:53:15)

[0mPOST /api/v1/orders [33m400[0m 29.640 ms - 49[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:10.168Z"}
[0mGET /api/csrf-token [32m200[0m 0.824 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:10.466Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST123',
      affiliateId: 'INVALID',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'medium',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST123

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Jane Smith

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: INVALID

      at log (server/controllers/orderController.js:62:13)

  console.log
    Affiliate not found with ID: INVALID

      at log (server/controllers/orderController.js:66:15)

[0mPOST /api/v1/orders [33m400[0m 58.285 ms - 50[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:11.003Z"}
[0mGET /api/csrf-token [32m200[0m 1.031 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:11.320Z"}
  console.log
    Creating order with data: {
      customerId: 'CUST999',
      affiliateId: 'AFF123',
      pickupDate: '2025-05-25',
      pickupTime: 'morning',
      estimatedSize: 'medium',
      deliveryDate: '2025-05-27',
      deliveryTime: 'afternoon'
    }

      at log (server/controllers/orderController.js:33:13)

  console.log
    Looking for customer with ID: CUST999

      at log (server/controllers/orderController.js:49:13)

  console.log
    Found customer: Bob Jones

      at log (server/controllers/orderController.js:59:13)

  console.log
    Looking for affiliate with ID: AFF123

      at log (server/controllers/orderController.js:62:13)

  console.log
    Found affiliate: John Doe

      at log (server/controllers/orderController.js:72:13)

[0mPOST /api/v1/orders [33m403[0m 57.500 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:11.852Z"}
[0mGET /api/csrf-token [32m200[0m 0.792 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:12.142Z"}
  console.log
    Validation errors: [
      {
        type: 'field',
        value: undefined,
        msg: 'Valid pickup date is required',
        path: 'pickupDate',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Invalid pickup time',
        path: 'pickupTime',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Invalid size',
        path: 'estimatedSize',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Valid delivery date is required',
        path: 'deliveryDate',
        location: 'body'
      },
      {
        type: 'field',
        value: undefined,
        msg: 'Invalid delivery time',
        path: 'deliveryTime',
        location: 'body'
      }
    ]

      at log (server/controllers/orderController.js:25:15)

[0mPOST /api/v1/orders [33m400[0m 5.543 ms - 497[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:12.622Z"}
[0mGET /api/csrf-token [32m200[0m 6.243 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/ORD123456 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:13.644Z"}
[0mGET /api/v1/orders/ORD123456 [32m200[0m 424.423 ms - 656[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:16.141Z"}
[0mGET /api/csrf-token [32m200[0m 189.518 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/ORD123456 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:22.363Z"}
[0mGET /api/v1/orders/ORD123456 [32m200[0m 714.067 ms - 656[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:25.070Z"}
[0mGET /api/csrf-token [32m200[0m 134.152 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/ORD123456 {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:39.859Z"}
[0mGET /api/v1/orders/ORD123456 [33m403[0m 479.453 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:42.496Z"}
[0mGET /api/csrf-token [32m200[0m 964.389 ms - 52[0m
[34mdebug[39m: GET /api/v1/orders/NONEXISTENT {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:45:56.035Z"}
[0mGET /api/v1/orders/NONEXISTENT [33m404[0m 818.325 ms - 45[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:46:53.730Z"}
[0mGET /api/csrf-token [32m200[0m 26.715 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:46:55.080Z"}
[0mPUT /api/v1/orders/ORD123456/status [32m200[0m 831.008 ms - 106[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:46:56.987Z"}
[0mGET /api/csrf-token [32m200[0m 106.764 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:01.840Z"}
[0mPUT /api/v1/orders/ORD123456/status [32m200[0m 128.819 ms - 175[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:02.541Z"}
[0mGET /api/csrf-token [32m200[0m 5.868 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:03.170Z"}
[0mPUT /api/v1/orders/ORD123456/status [33m400[0m 35.384 ms - 83[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:03.688Z"}
[0mGET /api/csrf-token [32m200[0m 6.963 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:04.446Z"}
[0mPUT /api/v1/orders/ORD123456/status [33m403[0m 76.625 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:05.031Z"}
[0mGET /api/csrf-token [32m200[0m 12.598 ms - 52[0m
[34mdebug[39m: PUT /api/v1/orders/ORD123456/status {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:06.137Z"}
[0mPUT /api/v1/orders/ORD123456/status [33m403[0m 132.457 ms - 42[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:06.955Z"}
[0mGET /api/csrf-token [32m200[0m 6.883 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:08.439Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [32m200[0m 676.441 ms - 57[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:11.361Z"}
[0mGET /api/csrf-token [32m200[0m 271.263 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:14.670Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [32m200[0m 316.770 ms - 57[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:16.034Z"}
[0mGET /api/csrf-token [32m200[0m 43.437 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:17.538Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [33m400[0m 33.516 ms - 77[0m
[34mdebug[39m: GET /api/csrf-token {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:18.093Z"}
[0mGET /api/csrf-token [32m200[0m 2.830 ms - 52[0m
[34mdebug[39m: POST /api/v1/orders/ORD123456/cancel {"service":"wavemax-affiliate","timestamp":"2025-05-28T14:47:18.410Z"}
[0mPOST /api/v1/orders/ORD123456/cancel [33m403[0m 27.837 ms - 42[0m
PASS tests/integration/order.test.js (133.611 s)
  Order Integration Tests
    POST /api/v1/orders
      ✓ should create order as customer (1422 ms)
      ✓ should create order as affiliate for their customer (882 ms)
      ✓ should fail with invalid customer ID (797 ms)
      ✓ should fail with invalid affiliate ID (835 ms)
      ✓ should fail when customer tries to create order for another customer (848 ms)
      ✓ should validate required fields (771 ms)
    GET /api/v1/orders/:orderId
      ✓ should return order details for customer (3362 ms)
      ✓ should return order details for affiliate (8848 ms)
      ✓ should fail for unauthorized customer (17059 ms)
      ✓ should return 404 for non-existent order (50770 ms)
    PUT /api/v1/orders/:orderId/status
      ✓ should update order status as affiliate (24169 ms)
      ✓ should update weight when processing (5597 ms)
      ✓ should prevent invalid status transitions (1153 ms)
      ✓ should fail for unauthorized affiliate (1341 ms)
      ✓ should fail for customers (1913 ms)
    POST /api/v1/orders/:orderId/cancel
      ✓ should cancel order as customer (4036 ms)
      ✓ should cancel order as affiliate (4674 ms)
      ✓ should prevent cancelling non-cancellable orders (2416 ms)
      ✓ should fail for unauthorized user (830 ms)
    Bulk order operations
      ○ skipped should update multiple orders status in bulk
      ○ skipped should handle partial bulk update failures
      ○ skipped should cancel multiple orders in bulk
    Order export functionality
      ○ skipped should export orders as CSV
      ○ skipped should export orders as JSON
      ○ skipped should export orders as Excel
      ○ skipped should respect export permissions
    Payment status updates
      ○ skipped should update payment status
      ○ skipped should handle payment failure
      ○ skipped should prevent payment status update on non-delivered orders
      ○ skipped should record refund
    Order filtering and search
      ○ skipped should search orders by customer name
      ○ skipped should filter orders by multiple criteria
      ○ skipped should filter by pickup time slots
      ○ skipped should provide aggregated statistics with filters

  console.log
    Connected to test database: mongodb+srv://***:***@cluster0.yiy75zr.mongodb.net/wavemax_test?retryWrites=true&w=majority

      at Object.log (tests/setup.js:43:13)

PASS tests/unit/authMiddleware.test.js
  Auth Middleware
    authenticate
      ✓ should authenticate valid Bearer token (526 ms)
      ✓ should authenticate valid x-auth-token header (234 ms)
      ✓ should reject request with no token (215 ms)
      ✓ should reject request with invalid token (215 ms)
      ✓ should reject request with expired token (214 ms)
      ✓ should handle malformed Authorization header (226 ms)
    authorize
      ✓ should authorize user with correct role (213 ms)
      ✓ should authorize user with one of multiple roles (218 ms)
      ✓ should reject user with incorrect role (216 ms)
      ✓ should reject user with no role (219 ms)
      ✓ should reject when user is not set (220 ms)
    authLimiter
      ✓ should be a function (212 ms)
      ✓ should have rate limit configuration (212 ms)

Killed
